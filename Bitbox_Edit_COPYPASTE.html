<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="PAD PUSHER - The essential preset editor for 1010music Bitbox Micro and mk2">
    <title>PAD PUSHER - Bitbox Preset Editor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #1a1a1a;
            min-height: 100vh;
            padding: 20px;
            color: #e0e0e0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #404040;
        }

        h1 {
            font-size: 1.8em;
            color: #4a9eff;
            font-weight: 600;
        }

        .mode-toggle {
            display: flex;
            gap: 5px;
            background: #1a1a1a;
            padding: 3px;
            border-radius: 6px;
        }

        .mode-btn {
            padding: 6px 16px;
            border: none;
            background: transparent;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            color: #888;
        }

        .mode-btn.active {
            background: #4a9eff;
            color: white;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
        }

        .pad-area {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 20px;
        }

        .pad-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .pad {
            aspect-ratio: 1;
            border: 2px solid #404040;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.15s;
            background: #2a2a2a;
            position: relative;
            user-select: none;
        }

        .pad:hover {
            border-color: #4a9eff;
            background: #333;
        }

        .pad.selected {
            background: #1a3a5a;
            border-color: #4a9eff;
            box-shadow: 0 0 15px rgba(74, 158, 255, 0.3);
        }

        .pad.active {
            background: #2a4a2a;
            border-color: #5eff5e;
        }

        .pad.active.selected {
            background: #1a5a3a;
            border-color: #5eff5e;
            box-shadow: 0 0 15px rgba(94, 255, 94, 0.3);
        }

        .pad.disabled {
            opacity: 0.3;
        }

        .pad.drag-over {
            background: #4a4a2a;
            border-color: #ffea5e;
            border-style: dashed;
        }

        .pad.dragging {
            opacity: 0.5;
        }

        .pad-number {
            font-size: 1.2em;
            font-weight: 600;
            color: #4a9eff;
            margin-bottom: 4px;
            pointer-events: none;
        }

        .pad.active .pad-number {
            color: #5eff5e;
        }

        .pad-label {
            font-size: 0.75em;
            color: #888;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 90%;
            pointer-events: none;
        }

        .pad.active .pad-label {
            color: #5eff5e;
        }

        .pad-status {
            position: absolute;
            top: 6px;
            right: 6px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #5eff5e;
            pointer-events: none;
        }

        .pad.empty .pad-status {
            background: #404040;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .panel {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 15px;
        }

        .panel h3 {
            color: #4a9eff;
            margin-bottom: 12px;
            font-size: 1em;
            font-weight: 600;
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .btn {
            padding: 10px 16px;
            border: 1px solid #404040;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.2s;
            background: #2a2a2a;
            color: #e0e0e0;
            text-align: left;
        }

        .btn:hover {
            background: #333;
            border-color: #4a9eff;
        }

        .btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #4a9eff;
            border-color: #4a9eff;
            color: white;
        }

        .btn-primary:hover {
            background: #3a8eef;
        }

        input[type="file"] {
            display: none;
        }

        .status-bar {
            background: #1a1a1a;
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 0.85em;
            color: #888;
            min-height: 32px;
        }

        .status-bar.success {
            color: #5eff5e;
        }

        .status-bar.error {
            color: #ff5e5e;
        }

        .info-panel {
            font-size: 0.85em;
            line-height: 1.6;
        }

        .info-panel p {
            margin-bottom: 8px;
            color: #888;
        }

        .info-panel strong {
            color: #4a9eff;
        }

        /* Context Menu */
        .context-menu {
            position: fixed;
            background: #2a2a2a;
            border: 1px solid #404040;
            border-radius: 6px;
            padding: 4px;
            display: none;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }

        .context-menu.show {
            display: block;
        }

        .context-item {
            padding: 8px 16px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.9em;
            transition: background 0.15s;
        }

        .context-item:hover {
            background: #333;
        }

        .context-item.disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 25px;
            width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid #404040;
        }

        .modal-header h2 {
            color: #4a9eff;
            font-size: 1.4em;
        }

        .close-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background: #404040;
            font-size: 1.3em;
            cursor: pointer;
            transition: all 0.2s;
            color: #888;
        }

        .close-btn:hover {
            background: #ff5e5e;
            color: white;
        }

        .param-section {
            margin-bottom: 20px;
        }

        .param-section h3 {
            color: #4a9eff;
            margin-bottom: 12px;
            font-size: 1em;
        }

        .param-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .param {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .param-label {
            font-weight: 500;
            color: #888;
            font-size: 0.85em;
        }

        .param-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .slider {
            flex: 1;
            height: 4px;
            border-radius: 2px;
            background: #404040;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #4a9eff;
            cursor: pointer;
        }

        .param-value {
            min-width: 75px;
            text-align: right;
            font-weight: 600;
            color: #4a9eff;
            font-size: 0.9em;
        }

        .select {
            padding: 8px;
            border: 1px solid #404040;
            border-radius: 6px;
            background: #1a1a1a;
            color: #e0e0e0;
            font-size: 0.9em;
            cursor: pointer;
        }

        .envelope-viz {
            width: 100%;
            height: 120px;
            background: #1a1a1a;
            border-radius: 6px;
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>PAD PUSHER</h1>
            <div class="mode-toggle">
                <button class="mode-btn active" data-mode="micro">Bitbox Micro</button>
                <button class="mode-btn" data-mode="mk2">Bitbox mk2</button>
            </div>
        </div>

        <div class="main-content">
            <div class="pad-area">
                <div class="pad-grid" id="padGrid"></div>
                <div class="status-bar" id="statusBar">Ready. Click to select, double-click to edit, right-click for
                    options.</div>
            </div>

            <div class="sidebar">
                <div class="panel">
                    <h3>File Operations</h3>
                    <div class="controls">
                        <button class="btn btn-primary" id="loadBtn">Load Preset</button>
                        <input type="file" id="fileInput" accept=".xml">
                        <button class="btn btn-primary" id="saveBtn">Save Preset</button>
                        <button class="btn" id="newPresetBtn">New Preset</button>
                    </div>
                </div>

                <div class="panel">
                    <h3>Pad Operations</h3>
                    <div class="controls">
                        <button class="btn" id="exportPadBtn" disabled>Export Selected</button>
                        <button class="btn" id="copyPadBtn" disabled>Copy</button>
                        <button class="btn" id="pastePadBtn" disabled>Paste</button>
                        <button class="btn" id="deletePadBtn" disabled>Delete</button>
                    </div>
                </div>

                <div class="panel info-panel">
                    <h3>Quick Guide</h3>
                    <p><strong>Click:</strong> Select pad</p>
                    <p><strong>Ctrl+Click:</strong> Multi-select</p>
                    <p><strong>Double-click:</strong> Edit parameters</p>
                    <p><strong>Right-click:</strong> Context menu</p>
                    <p><strong>Drag:</strong> Move/swap pads</p>
                    <p><strong>Drop files:</strong> Load XML/SFZ/WAV</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu">
        <div class="context-item" id="contextEdit">Edit Pad</div>
        <div class="context-item" id="contextExport">Export Pad</div>
        <div class="context-item" id="contextCopy">Copy</div>
        <div class="context-item" id="contextPaste">Paste</div>
        <div class="context-item" id="contextDelete">Delete</div>
    </div>

    <!-- Edit Modal -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Edit Pad</h2>
                <button class="close-btn" id="closeModal">Ã—</button>
            </div>

            <div class="param-section">
                <h3>Main Parameters</h3>
                <div class="param-grid">
                    <div class="param">
                        <label class="param-label">Level</label>
                        <div class="param-control">
                            <input type="range" class="slider" id="gaindb" min="-96000" max="12000" value="0">
                            <span class="param-value" id="gaindb-val">0.0 dB</span>
                        </div>
                    </div>
                    <div class="param">
                        <label class="param-label">Pitch</label>
                        <div class="param-control">
                            <input type="range" class="slider" id="pitch" min="-24000" max="24000" value="0">
                            <span class="param-value" id="pitch-val">0.00 st</span>
                        </div>
                    </div>
                    <div class="param">
                        <label class="param-label">Pan</label>
                        <div class="param-control">
                            <input type="range" class="slider" id="panpos" min="-1000" max="1000" value="0">
                            <span class="param-value" id="panpos-val">Center</span>
                        </div>
                    </div>
                    <div class="param">
                        <label class="param-label">Filter</label>
                        <div class="param-control">
                            <input type="range" class="slider" id="dualfilcutoff" min="-1000" max="1000" value="0">
                            <span class="param-value" id="dualfilcutoff-val">0.0%</span>
                        </div>
                    </div>
                    <div class="param">
                        <label class="param-label">Resonance</label>
                        <div class="param-control">
                            <input type="range" class="slider" id="res" min="0" max="1000" value="500">
                            <span class="param-value" id="res-val">50.0%</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="param-section">
                <h3>Envelope</h3>
                <canvas class="envelope-viz" id="envelopeCanvas"></canvas>
                <div class="param-grid">
                    <div class="param">
                        <label class="param-label">Attack</label>
                        <div class="param-control">
                            <input type="range" class="slider" id="envattack" min="0" max="1000" value="0">
                            <span class="param-value" id="envattack-val">0.0%</span>
                        </div>
                    </div>
                    <div class="param">
                        <label class="param-label">Decay</label>
                        <div class="param-control">
                            <input type="range" class="slider" id="envdecay" min="0" max="1000" value="0">
                            <span class="param-value" id="envdecay-val">0.0%</span>
                        </div>
                    </div>
                    <div class="param">
                        <label class="param-label">Sustain</label>
                        <div class="param-control">
                            <input type="range" class="slider" id="envsus" min="0" max="1000" value="1000">
                            <span class="param-value" id="envsus-val">100.0%</span>
                        </div>
                    </div>
                    <div class="param">
                        <label class="param-label">Release</label>
                        <div class="param-control">
                            <input type="range" class="slider" id="envrel" min="0" max="1000" value="200">
                            <span class="param-value" id="envrel-val">20.0%</span>
                        </div>
                    </div>
                </div>
            </div>

        

            <div class="param-section">
                <h3>Configuration</h3>
                <div class="param-grid">
                    <div class="param">
                        <label class="param-label">Cell Mode</label>
                        <select class="select" id="cellmode">
                            <option value="0">Sample</option>
                            <option value="1">Clip</option>
                            <option value="2">Slicer</option>
                            <option value="3">Granular</option>
                        </select>
                    </div>
                    <div class="param">
                        <label class="param-label">Loop Mode</label>
                        <select class="select" id="loopmodes">
                            <option value="0">Off</option>
                            <option value="1">Forward</option>
                            <option value="2">Bidirect</option>
                        </select>
                    </div>
                    <div class="param">
                        <label class="param-label">Launch Mode</label>
                        <select class="select" id="samtrigtype">
                            <option value="0">Gate</option>
                            <option value="1">Trigger</option>
                            <option value="2">Toggle</option>
                        </select>
                    </div>
                    <div class="param">
                        <label class="param-label">Poly Mode</label>
                        <select class="select" id="polymode">
                            <option value="0">Mono</option>
                            <option value="1">Poly 2</option>
                            <option value="2">Poly 4</option>
                            <option value="3">Poly 6</option>
                            <option value="4">Poly 8</option>
                            <option value="5">Poly Infinite</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentMode = 'micro';
        let presetData = null;
        let selectedPads = new Set();
        let clipboard = null;
        let draggedPad = null;
        let currentEditingPad = null;
        let assetCells = []; // Store asset references

        function createEmptyPadData() {
            return {
                filename: '',
                type: 'samtempl',
                params: {
                    gaindb: '0', 
                    pitch: '0', 
                    panpos: '0',
                    samtrigtype: '0', 
                    loopmode: '0', 
                    loopmodes: '0',
                    midimode: '0', 
                    reverse: '0', 
                    cellmode: '0',
                    envattack: '0', 
                    envdecay: '0', 
                    envsus: '1000', 
                    envrel: '200',
                    samstart: '0', 
                    samlen: '0', 
                    loopstart: '0', 
                    loopend: '0',
                    quantsize: '3', 
                    synctype: '5', 
                    actslice: '1',
                    outputbus: '0', 
                    polymode: '0', 
                    polymodeslice: '0',
                    slicestepmode: '0', 
                    chokegrp: '0', 
                    dualfilcutoff: '0',
                    res: '500', 
                    rootnote: '0', 
                    beatcount: '0',
                    fx1send: '0', 
                    fx2send: '0', 
                    multisammode: '0',
                    interpqual: '0', 
                    playthru: '0', 
                    slicerquantsize: '13',
                    slicersync: '0', 
                    padnote: '0', 
                    loopfadeamt: '0',
                    lfowave: '0', 
                    lforate: '100', 
                    lfoamount: '1000',
                    lfokeytrig: '0', 
                    lfobeatsync: '0', 
                    lforatebeatsync: '0',
                    grainsizeperc: '300', 
                    grainscat: '0', 
                    grainpanrnd: '0',
                    graindensity: '600', 
                    slicemode: '0', 
                    legatomode: '0',
                    gainssrcwin: '0', 
                    grainreadspeed: '1000',
                    recpresetlen: '0', 
                    recquant: '3', 
                    recinput: '0',
                    recusethres: '0', 
                    recthresh: '-20000', 
                    recmonoutbus: '0',
                    deftemplate: '1'
                },
                modsources: []
            };
        }

        function createEmptyPreset() {
            presetData = {
                version: '2',
                pads: {},
                tempo: '120'
            };

            assetCells = [];

            for (let row = 0; row < 4; row++) {
                presetData.pads[row] = {};
                for (let col = 0; col < 4; col++) {
                    presetData.pads[row][col] = createEmptyPadData();
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log('PAD PUSHER: Initializing...');
            try {
                createEmptyPreset();
                // console.log('PAD PUSHER: Preset created');
                createPadGrid();
                // console.log('PAD PUSHER: Pad grid created');
                setupEventListeners();
                // console.log('PAD PUSHER: Event listeners setup');
                setStatus('Ready');
                console.log('PAD PUSHER: Ready!');
            } catch (error) {
                console.error('PAD PUSHER ERROR:', error);
                setStatus('Initialization error - check console', 'error');
            }
        });

        function createPadGrid() {
            const grid = document.getElementById('padGrid');
            grid.innerHTML = '';

            console.log('Creating pad grid...');

            for (let row = 3; row >= 0; row--) {
                for (let col = 0; col < 4; col++) {
                    const padNum = (row * 4) + col + 1;
                    const pad = document.createElement('div');
                    pad.className = 'pad empty';
                    pad.dataset.row = row;
                    pad.dataset.col = col;
                    pad.dataset.padnum = padNum;
                    // pad.draggable = true;

                    pad.setAttribute('draggable', 'true');

                    if (currentMode === 'micro' && row > 1) {
                        pad.classList.add('disabled');
                    }

                    pad.innerHTML = `
                        <span class="pad-number">${padNum}</span>
                        <span class="pad-label">Empty</span>
                        <span class="pad-status"></span>
                    `;

                    setupPadEvents(pad);
                    grid.appendChild(pad);
                }
            }
            
            console.log('Pad grid created');
        }

        function setupPadEvents(pad) {
            pad.addEventListener('click', (e) => handlePadClick(e, pad));
            pad.addEventListener('dblclick', () => openEditModal(pad));
            pad.addEventListener('contextmenu', (e) => showContextMenu(e, pad));
                        pad.addEventListener('dragstart', (e) => {
                console.log('DRAGSTART on pad:', pad.dataset.padnum);
                handleDragStart(e, pad);
            });
            pad.addEventListener('dragover', (e) => {
                handleDragOver(e, pad);
            });
            pad.addEventListener('drop', (e) => {
                console.log('DROP on pad:', pad.dataset.padnum);
                handleDrop(e, pad);
            });
            pad.addEventListener('dragend', () => {
                console.log('DRAGEND');
                pad.classList.remove('dragging');
                document.querySelectorAll('.pad.drag-over').forEach(p => p.classList.remove('drag-over'));
            });
            pad.addEventListener('dragleave', () => pad.classList.remove('drag-over'));
        }

        function handlePadClick(e, pad) {
            if (e.ctrlKey || e.metaKey) {
                togglePadSelection(pad);
            } else {
                clearPadSelection();
                selectPad(pad);
            }
            updateButtonStates();
        }

        function selectPad(pad) {
            pad.classList.add('selected');
            selectedPads.add(pad.dataset.padnum);
        }

        function togglePadSelection(pad) {
            if (pad.classList.contains('selected')) {
                pad.classList.remove('selected');
                selectedPads.delete(pad.dataset.padnum);
            } else {
                selectPad(pad);
            }
        }

        function clearPadSelection() {
            document.querySelectorAll('.pad.selected').forEach(p => p.classList.remove('selected'));
            selectedPads.clear();
        }

        function updateButtonStates() {
            const hasSelection = selectedPads.size > 0;
            document.getElementById('exportPadBtn').disabled = !hasSelection;
            document.getElementById('copyPadBtn').disabled = !hasSelection;
            document.getElementById('deletePadBtn').disabled = !hasSelection;
            document.getElementById('pastePadBtn').disabled = !clipboard;
        }

        function handleDragStart(e, pad) {
            draggedPad = pad;
            pad.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', pad.dataset.padnum);
        }

        function handleDragOver(e, pad) {
            e.preventDefault();
            e.stopPropagation();
            e.dataTransfer.dropEffect = 'move';
            if (draggedPad && draggedPad !== pad) {
                pad.classList.add('drag-over');
            }
        }

        function handleDrop(e, pad) {
            e.preventDefault();
            e.stopPropagation();
            pad.classList.remove('drag-over');

            if (e.dataTransfer.files.length > 0) {
                handleFileDropOnPad(e.dataTransfer.files[0], pad);
            } else if (draggedPad && draggedPad !== pad) {
                console.log('Swapping pads:', draggedPad.dataset.padnum, 'with', pad.dataset.padnum);
                swapPads(draggedPad, pad);
            }

            if (draggedPad) {
                draggedPad.classList.remove('dragging');
                draggedPad = null;
            }
        }

       function swapPads(pad1, pad2) {
            const row1 = parseInt(pad1.dataset.row);
            const col1 = parseInt(pad1.dataset.col);
            const row2 = parseInt(pad2.dataset.row);
            const col2 = parseInt(pad2.dataset.col);

            // Swap the data
            const temp = presetData.pads[row1][col1];
            presetData.pads[row1][col1] = presetData.pads[row2][col2];
            presetData.pads[row2][col2] = temp;

            // Update asset references with proper type conversion
            assetCells.forEach(asset => {
                const assetRow = parseInt(asset.params.asssrcrow);
                const assetCol = parseInt(asset.params.asssrccol);
                
                if (assetRow === row1 && assetCol === col1) {
                    asset.params.asssrcrow = String(row2);
                    asset.params.asssrccol = String(col2);
                } else if (assetRow === row2 && assetCol === col2) {
                    asset.params.asssrcrow = String(row1);
                    asset.params.asssrccol = String(col1);
                }
            });

            // Force visual update by recreating the pad display
            updatePadDisplay();
            
            setStatus(`Swapped Pad ${pad1.dataset.padnum} with Pad ${pad2.dataset.padnum}`, 'success');
        }

        function handleFileDropOnPad(file, pad) {
            if (file.name.endsWith('.xml')) {
                if (confirm(`Load preset from ${file.name}? All current pads will be lost!`)) {
                    loadPreset(file);
                }
            } else if (file.name.endsWith('.json')) {
                loadPadFromJSON(file, pad);
            } else if (file.name.endsWith('.sfz')) {
                setStatus('SFZ import coming soon!');
            } else if (file.name.endsWith('.wav')) {
                setStatus('WAV import coming soon!');
            }
        }

        async function loadPadFromJSON(file, targetPad) {
            try {
                const text = await file.text();
                const padData = JSON.parse(text);

                const row = parseInt(targetPad.dataset.row);
                const col = parseInt(targetPad.dataset.col);

                if (padData.data) {
                    presetData.pads[row][col] = JSON.parse(JSON.stringify(padData.data));
                    updatePadDisplay();
                    setStatus(`Loaded pad from ${file.name}`, 'success');
                } else {
                    setStatus('Invalid pad JSON format', 'error');
                }
            } catch (error) {
                setStatus(`Error loading pad: ${error.message}`, 'error');
            }
        }

        function setupEventListeners() {
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentMode = btn.dataset.mode;
                    createPadGrid();
                    updatePadDisplay();
                });
            });

            document.getElementById('loadBtn').addEventListener('click', () => document.getElementById('fileInput').click());
            document.getElementById('fileInput').addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    if (confirm(`Load preset? All current pads will be lost!`)) {
                        loadPreset(e.target.files[0]);
                    }
                }
                e.target.value = ''; // Reset file input
            });

            document.getElementById('saveBtn').addEventListener('click', savePreset);
            document.getElementById('newPresetBtn').addEventListener('click', () => {
                if (confirm('Create new preset? All current pads will be lost!')) {
                    createEmptyPreset();
                    updatePadDisplay();
                    setStatus('New preset created');
                }
            });

            document.getElementById('exportPadBtn').addEventListener('click', exportSelectedPads);
            document.getElementById('copyPadBtn').addEventListener('click', copySelectedPads);
            document.getElementById('pastePadBtn').addEventListener('click', pasteToSelected);
            document.getElementById('deletePadBtn').addEventListener('click', deleteSelectedPads);

            document.getElementById('closeModal').addEventListener('click', closeEditModal);
            document.getElementById('editModal').addEventListener('click', (e) => {
                if (e.target.id === 'editModal') closeEditModal();
            });

            document.addEventListener('click', (e) => {
                if (!e.target.closest('.context-menu')) {
                    hideContextMenu();
                }
            });

            setupParameterListeners();
            setupDragDrop();
        }

        function setupDragDrop() {
            const grid = document.getElementById('padGrid');
            grid.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'copy';
            });
        }

        function showContextMenu(e, pad) {
            e.preventDefault();

            // Don't deselect if right-clicking on already selected pad
            if (!pad.classList.contains('selected')) {
                clearPadSelection();
                selectPad(pad);
            }

            const menu = document.getElementById('contextMenu');
            menu.style.left = e.pageX + 'px';
            menu.style.top = e.pageY + 'px';
            menu.classList.add('show');

            document.getElementById('contextEdit').onclick = () => {
                openEditModal(pad);
                hideContextMenu();
            };
            document.getElementById('contextExport').onclick = () => {
                exportSelectedPads();
                hideContextMenu();
            };
            document.getElementById('contextCopy').onclick = () => {
                copySelectedPads();
                hideContextMenu();
            };
            document.getElementById('contextPaste').onclick = () => {
                pasteToSelected();
                hideContextMenu();
            };
            document.getElementById('contextDelete').onclick = () => {
                deleteSelectedPads();
                hideContextMenu();
            };

            updateButtonStates();
        }

        function hideContextMenu() {
            document.getElementById('contextMenu').classList.remove('show');
        }

        function setupParameterListeners() {
            const params = [
                'gaindb', 
                'pitch', 
                'panpos', 
                'dualfilcutoff', 
                'res',
                'envattack', 
                'envdecay', 
                'envsus', 
                'envrel'
            ];

            params.forEach(param => {
                const slider = document.getElementById(param);
                const display = document.getElementById(param + '-val');

                if (slider && display) {
                    // Slider input
                    slider.addEventListener('input', () => {
                        updateParamDisplay(param, slider.value);
                        if (currentEditingPad && presetData) {
                            const row = parseInt(currentEditingPad.dataset.row);
                            const col = parseInt(currentEditingPad.dataset.col);
                            presetData.pads[row][col].params[param] = slider.value;
                        }
                        if (param.startsWith('env')) drawEnvelope();
                    });

                    // Make display editable
                    display.style.cursor = 'text';
                    display.contentEditable = true;
                    display.addEventListener('blur', () => {
                        const value = parseDisplayValue(param, display.textContent);
                        if (value !== null) {
                            slider.value = value;
                            updateParamDisplay(param, value);
                            if (currentEditingPad && presetData) {
                                const row = parseInt(currentEditingPad.dataset.row);
                                const col = parseInt(currentEditingPad.dataset.col);
                                presetData.pads[row][col].params[param] = value;
                            }
                            if (param.startsWith('env')) drawEnvelope();
                        }
                    });
                    display.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            display.blur();
                        }
                    });
                }
            });

            // Dropdowns
            ['cellmode', 'loopmodes', 'samtrigtype', 'polymode'].forEach(param => {
                const select = document.getElementById(param);
                if (select) {
                    select.addEventListener('change', () => {
                        if (currentEditingPad && presetData) {
                            const row = parseInt(currentEditingPad.dataset.row);
                            const col = parseInt(currentEditingPad.dataset.col);
                            presetData.pads[row][col].params[param] = select.value;
                        }
                    });
                }
            });
        }

        function parseDisplayValue(param, text) {
            text = text.trim().replace(/[^\d.-]/g, '');
            const val = parseFloat(text);
            if (isNaN(val)) return null;

            switch (param) {
                case 'gaindb':
                case 'pitch':
                    return Math.round(val * 1000);
                case 'panpos':
                case 'dualfilcutoff':
                case 'res':
                case 'envattack':
                case 'envdecay':
                case 'envsus':
                case 'envrel':
                    return Math.round(val * 10);
                default:
                    return Math.round(val);
            }
        }

        function updateParamDisplay(param, value) {
            const display = document.getElementById(param + '-val');
            if (!display) return;

            const val = parseFloat(value);
            let text = '';

            switch (param) {
                case 'gaindb':
                    text = (val >= 0 ? '+' : '') + (val / 1000).toFixed(1) + ' dB';
                    break;
                case 'pitch':
                    text = (val >= 0 ? '+' : '') + (val / 1000).toFixed(2) + ' st';
                    break;
                case 'panpos':
                    if (val === 0) text = 'Center';
                    else if (val < 0) text = 'L ' + Math.abs(val / 10).toFixed(1) + '%';
                    else text = 'R ' + (val / 10).toFixed(1) + '%';
                    break;
                default:
                    text = (val / 10).toFixed(1) + '%';
            }
            display.textContent = text;
        }

        function drawEnvelope() {
            const canvas = document.getElementById('envelopeCanvas');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const width = canvas.width = canvas.offsetWidth;
            const height = canvas.height = canvas.offsetHeight;

            ctx.clearRect(0, 0, width, height);

            const attack = parseFloat(document.getElementById('envattack').value) / 1000;
            const decay = parseFloat(document.getElementById('envdecay').value) / 1000;
            const sustain = parseFloat(document.getElementById('envsus').value) / 1000;
            const release = parseFloat(document.getElementById('envrel').value) / 1000;

            ctx.strokeStyle = '#4a9eff';
            ctx.lineWidth = 2;
            ctx.beginPath();

            const pad = 15;
            const w = width - pad * 2;
            const h = height - pad * 2;

            const total = attack + decay + 0.4 + release;
            const ax = (attack / total) * w;
            const dx = (decay / total) * w;
            const sx = (0.4 / total) * w;
            const rx = (release / total) * w;

            ctx.moveTo(pad, pad + h);
            ctx.lineTo(pad + ax, pad);
            ctx.lineTo(pad + ax + dx, pad + h * (1 - sustain));
            ctx.lineTo(pad + ax + dx + sx, pad + h * (1 - sustain));
            ctx.lineTo(pad + ax + dx + sx + rx, pad + h);

            ctx.stroke();
        }

        function openEditModal(pad) {
            const row = parseInt(pad.dataset.row);
            const col = parseInt(pad.dataset.col);
            const padData = presetData.pads[row][col];

            if (!padData) return;

            currentEditingPad = pad;
            document.getElementById('modalTitle').textContent =
                `Pad ${pad.dataset.padnum} - ${padData.filename || 'Empty'}`;

            loadParamsToModal(padData);
            document.getElementById('editModal').classList.add('show');
            drawEnvelope();
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('show');
            currentEditingPad = null;
            updatePadDisplay();
        }

        function loadParamsToModal(padData) {
            const params = padData.params;

            ['gaindb', 'pitch', 'panpos', 'dualfilcutoff', 'res',
                'envattack', 'envdecay', 'envsus', 'envrel'].forEach(param => {
                    const slider = document.getElementById(param);
                    if (slider && params[param] !== undefined) {
                        slider.value = params[param];
                        updateParamDisplay(param, params[param]);
                    }
                });

            ['cellmode', 'loopmodes', 'samtrigtype', 'polymode'].forEach(param => {
                const select = document.getElementById(param);
                if (select && params[param] !== undefined) {
                    select.value = params[param];
                }
            });
        }

        async function loadPreset(file) {
            try {
                const text = await file.text();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(text, 'text/xml');

                presetData = { version: '2', pads: {}, tempo: '120' };
                assetCells = [];

                // Parse layer 0 cells (pads)
                const cells = xmlDoc.querySelectorAll('cell[layer="0"]');

                cells.forEach(cell => {
                    const row = parseInt(cell.getAttribute('row'));
                    const col = parseInt(cell.getAttribute('column'));

                    if (isNaN(row) || isNaN(col)) return;
                    if (!presetData.pads[row]) presetData.pads[row] = {};

                    const padData = {
                        filename: cell.getAttribute('filename') || '',
                        type: cell.getAttribute('type'),
                        params: {},
                        modsources: []
                    };

                    const params = cell.querySelector('params');
                    if (params) {
                        Array.from(params.attributes).forEach(attr => {
                            padData.params[attr.name] = attr.value;
                        });
                    }

                    cell.querySelectorAll('modsource').forEach(mod => {
                        padData.modsources.push({
                            dest: mod.getAttribute('dest'),
                            src: mod.getAttribute('src'),
                            slot: mod.getAttribute('slot'),
                            amount: mod.getAttribute('amount')
                        });
                    });

                    presetData.pads[row][col] = padData;
                });

                // Parse asset cells (multi-samples)
                const assetNodes = xmlDoc.querySelectorAll('cell[type="asset"]');
                assetNodes.forEach((asset, index) => {
                    const params = asset.querySelector('params');
                    if (params) {
                        assetCells.push({
                            row: index,
                            filename: asset.getAttribute('filename') || '',
                            params: {
                                rootnote: params.getAttribute('rootnote') || '60',
                                keyrangebottom: params.getAttribute('keyrangebottom') || '0',
                                keyrangetop: params.getAttribute('keyrangetop') || '127',
                                velroot: params.getAttribute('velroot') || '64',
                                velrangebottom: params.getAttribute('velrangebottom') || '0',
                                velrangetop: params.getAttribute('velrangetop') || '127',
                                asssrcrow: params.getAttribute('asssrcrow') || '0',
                                asssrccol: params.getAttribute('asssrccol') || '0'
                            }
                        });
                    }
                });

                // Fill missing pads
                for (let row = 0; row < 4; row++) {
                    if (!presetData.pads[row]) presetData.pads[row] = {};
                    for (let col = 0; col < 4; col++) {
                        if (!presetData.pads[row][col]) {
                            presetData.pads[row][col] = createEmptyPadData();
                        }
                    }
                }

                const songCell = xmlDoc.querySelector('cell[type="song"]');
                if (songCell) {
                    const params = songCell.querySelector('params');
                    if (params) presetData.tempo = params.getAttribute('globtempo') || '120';
                }

                updatePadDisplay();
                setStatus(`Loaded: ${file.name} (${assetCells.length} multi-sample assets)`, 'success');
            } catch (error) {
                setStatus(`Error loading: ${error.message}`, 'error');
                console.error(error);
            }
        }

        function savePreset() {
            if (!presetData) {
                setStatus('No preset to save', 'error');
                return;
            }

            try {
                const xml = generatePresetXML(presetData);
                const blob = new Blob([xml], { type: 'text/xml' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'preset.xml';
                a.click();
                URL.revokeObjectURL(url);

                setStatus('Preset saved successfully', 'success');
            } catch (error) {
                setStatus(`Error saving: ${error.message}`, 'error');
                console.error(error);
            }
        }

        function generatePresetXML(data) {
            let xml = '<?xml version="1.0" encoding="UTF-8"?>\n<document>\n    <session version="2">\n';

            // Layer 0 - Pads
            for (let row = 0; row < 4; row++) {
                for (let col = 0; col < 4; col++) {
                    const pad = data.pads[row]?.[col];
                    if (!pad) continue;

                    xml += `        <cell row="${row}" column="${col}" layer="0" filename="${pad.filename}" type="${pad.type}">\n`;
                    xml += '            <params';
                    for (let [key, value] of Object.entries(pad.params)) {
                        xml += ` ${key}="${value}"`;
                    }
                    xml += '/>\n';

                    if (pad.modsources?.length > 0) {
                        pad.modsources.forEach(mod => {
                            xml += `            <modsource dest="${mod.dest}" src="${mod.src}" slot="${mod.slot}" amount="${mod.amount}"/>\n`;
                        });
                    }

                    xml += '            <slices/>\n        </cell>\n';
                }
            }

            // Layer 3 - FX
            xml += '        <cell row="0" layer="3" type="delay">\n            <params delay="400" delaymustime="6" feedback="400" cutoff="120" filtquality="1000" dealybeatsync="1" filtenable="1" delaypingpong="1"/>\n        </cell>\n';
            xml += '        <cell row="1" layer="3" type="reverb">\n            <params decay="600" predelay="40" damping="500"/>\n        </cell>\n';
            xml += '        <cell row="2" layer="3" type="eq">\n            <params eqactband="0" eqgain="0" eqcutoff="200" eqres="400" eqenable="1" eqtype="0" eqgain2="0" eqcutoff2="400" eqres2="400" eqenable2="1" eqtype2="0" eqgain3="0" eqcutoff3="600" eqres3="400" eqenable3="1" eqtype3="0" eqgain4="0" eqcutoff4="800" eqres4="400" eqenable4="1" eqtype4="0"/>\n        </cell>\n';
            xml += '        <cell row="3" layer="3" type="null">\n            <params/>\n        </cell>\n';
            xml += '        <cell row="4" layer="3" type="null">\n            <params/>\n        </cell>\n';

            // Asset cells - preserve multi-sample references
            assetCells.forEach((asset, index) => {
                xml += `        <cell row="${index}" filename="${asset.filename}" type="asset">\n`;
                xml += `            <params rootnote="${asset.params.rootnote}" keyrangebottom="${asset.params.keyrangebottom}" keyrangetop="${asset.params.keyrangetop}" velroot="${asset.params.velroot}" velrangebottom="${asset.params.velrangebottom}" velrangetop="${asset.params.velrangetop}" asssrcrow="${asset.params.asssrcrow}" asssrccol="${asset.params.asssrccol}"/>\n`;
                xml += '        </cell>\n';
            });

            // Layer 8 - Inputs
            for (let i = 0; i < 8; i++) {
                xml += `        <cell row="${i}" layer="8" type="ioconnectin">\n            <params inputiocon="gatein"/>\n        </cell>\n`;
            }

            // Layer 9 - Outputs
            const outputs = ['chanout1', 'chanout2', 'chanout3', 'chanout4', 'chanout5', 'chanout6', 'masterout1', 'masterout2'];
            for (let i = 0; i < 8; i++) {
                xml += `        <cell row="${i}" layer="9" type="ioconnectout">\n            <params outputiocon="${outputs[i]}"/>\n        </cell>\n`;
            }

            // Song settings
            xml += `        <cell type="song">\n            <params globtempo="${data.tempo}" songmode="0" sectcount="1" sectloop="1" swing="50" keymode="1" keyroot="3"/>\n        </cell>\n`;
            xml += '    </session>\n</document>\n';

            return xml;
        }

        function exportSelectedPads() {
            if (selectedPads.size === 0) {
                setStatus('No pads selected', 'error');
                return;
            }

            const exports = [];
            selectedPads.forEach(padNum => {
                const pad = document.querySelector(`[data-padnum="${padNum}"]`);
                const row = parseInt(pad.dataset.row);
                const col = parseInt(pad.dataset.col);
                const padData = presetData.pads[row][col];

                if (padData && padData.filename) {
                    exports.push({
                        padNumber: padNum,
                        row: row,
                        col: col,
                        data: padData
                    });
                }
            });

            if (exports.length === 0) {
                setStatus('Selected pads are empty', 'error');
                return;
            }

            const json = JSON.stringify(exports.length === 1 ? exports[0] : exports, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pad_export_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);

            setStatus(`Exported ${exports.length} pad(s)`, 'success');
        }

        function copySelectedPads() {
            if (selectedPads.size === 0) {
                setStatus('No pads selected', 'error');
                return;
            }

            clipboard = [];
            selectedPads.forEach(padNum => {
                const pad = document.querySelector(`[data-padnum="${padNum}"]`);
                const row = parseInt(pad.dataset.row);
                const col = parseInt(pad.dataset.col);
                clipboard.push(JSON.parse(JSON.stringify(presetData.pads[row][col])));
            });

            updateButtonStates();
            setStatus(`Copied ${clipboard.length} pad(s)`, 'success');
        }

        function pasteToSelected() {
            if (!clipboard || clipboard.length === 0) {
                setStatus('Nothing to paste', 'error');
                return;
            }

            if (selectedPads.size === 0) {
                setStatus('No destination pad selected', 'error');
                return;
            }

            const targets = Array.from(selectedPads);
            clipboard.forEach((data, i) => {
                if (i >= targets.length) return;
                const pad = document.querySelector(`[data-padnum="${targets[i]}"]`);
                const row = parseInt(pad.dataset.row);
                const col = parseInt(pad.dataset.col);
                presetData.pads[row][col] = JSON.parse(JSON.stringify(data));
            });

            updatePadDisplay();
            setStatus(`Pasted ${Math.min(clipboard.length, targets.length)} pad(s)`, 'success');
        }

        function deleteSelectedPads() {
            if (selectedPads.size === 0) {
                setStatus('No pads selected', 'error');
                return;
            }

            const count = selectedPads.size;
            selectedPads.forEach(padNum => {
                const pad = document.querySelector(`[data-padnum="${padNum}"]`);
                const row = parseInt(pad.dataset.row);
                const col = parseInt(pad.dataset.col);
                presetData.pads[row][col] = createEmptyPadData();
            });

            updatePadDisplay();
            clearPadSelection();
            updateButtonStates();
            setStatus(`Deleted ${count} pad(s)`, 'success');
        }

        function updatePadDisplay() {
            if (!presetData) return;

            for (let row = 0; row < 4; row++) {
                for (let col = 0; col < 4; col++) {
                    const pad = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
                    if (!pad) continue;

                    const padData = presetData.pads[row]?.[col];
                    const label = pad.querySelector('.pad-label');

                    if (padData && padData.filename && padData.type !== 'samtempl') {
                        pad.classList.remove('empty');
                        pad.classList.add('active');
                        label.textContent = padData.filename.split(/[/\\]/).pop().replace('.wav', '');
                    } else {
                        pad.classList.add('empty');
                        pad.classList.remove('active');
                        label.textContent = 'Empty';
                    }
                }
            }
        }

        function setStatus(message, type = '') {
            const bar = document.getElementById('statusBar');
            bar.textContent = message;
            bar.className = 'status-bar ' + type;
        }
    </script>
</body>

</html>