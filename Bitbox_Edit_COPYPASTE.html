<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="BITBOXER - The essential preset editor for 1010music Bitbox Micro and mk2">
    <title>BITBOXER - Bitbox Preset Editor</title>

    <!-- <script src="https://unpkg.com/fflate@0.8.2/lib/browser.js"></script> -->
    <script src="fflate.js" defer></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #1a1a1a;
            min-height: 100vh;
            padding: 20px;
            color: #e0e0e0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #404040;
        }

        h1 {
            font-size: 1.8em;
            color: #4a9eff;
            font-weight: 600;
        }

        .mode-toggle {
            display: flex;
            gap: 5px;
            background: #1a1a1a;
            padding: 3px;
            border-radius: 6px;
        }

        .mode-btn {
            padding: 6px 16px;
            border: none;
            background: transparent;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            color: #888;
        }

        .mode-btn.active {
            background: #4a9eff;
            color: white;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
        }

        .pad-area {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 20px;
        }

        .pad-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .pad {
            aspect-ratio: 1;
            border: 2px solid #404040;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.15s;
            background: #2a2a2a;
            position: relative;
            user-select: none;
        }

        .pad:hover {
            border-color: #4a9eff;
            background: #333;
        }

        .pad.selected {
            background: #1a3a5a;
            border-color: #4a9eff;
            box-shadow: 0 0 15px rgba(74, 158, 255, 0.3);
        }

        .pad.active {
            background: #2a4a2a;
            border-color: #5eff5e;
        }

        .pad.active.selected {
            background: #1a5a3a;
            border-color: #5eff5e;
            box-shadow: 0 0 15px rgba(94, 255, 94, 0.3);
        }

        .pad.disabled {
            opacity: 0.3;
        }

        .pad.drag-over {
            background: #4a4a2a;
            border-color: #ffea5e;
            border-style: dashed;
        }

        .pad.dragging {
            opacity: 0.5;
        }

        .pad-number {
            font-size: 1.2em;
            font-weight: 600;
            color: #4a9eff;
            margin-bottom: 4px;
            pointer-events: none;
        }

        .pad.active .pad-number {
            color: #5eff5e;
        }

        .pad-label {
            font-size: 0.75em;
            color: #888;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 90%;
            pointer-events: none;
        }

        .pad.active .pad-label {
            color: #5eff5e;
        }

        .pad-status {
            position: absolute;
            top: 6px;
            right: 6px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #5eff5e;
            pointer-events: none;
        }

        .pad.empty .pad-status {
            background: #404040;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .panel {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 15px;
        }

        .panel h3 {
            color: #4a9eff;
            margin-bottom: 12px;
            font-size: 1em;
            font-weight: 600;
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .btn {
            padding: 10px 16px;
            border: 1px solid #404040;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.2s;
            background: #2a2a2a;
            color: #e0e0e0;
            text-align: left;
        }

        .btn:hover {
            background: #333;
            border-color: #4a9eff;
        }

        .btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #4a9eff;
            border-color: #4a9eff;
            color: white;
        }

        .btn-primary:hover {
            background: #3a8eef;
        }

        input[type="file"] {
            display: none;
        }

        .status-bar {
            background: #1a1a1a;
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 0.85em;
            color: #888;
            min-height: 32px;
        }

        .status-bar.success {
            color: #5eff5e;
        }

        .status-bar.error {
            color: #ff5e5e;
        }

        .info-panel {
            font-size: 0.85em;
            line-height: 1.6;
        }

        .info-panel p {
            margin-bottom: 8px;
            color: #888;
        }

        .info-panel strong {
            color: #4a9eff;
        }

        /* Context Menu */
        .context-menu {
            position: absolute;
            background: #2a2a2a;
            border: 1px solid #404040;
            border-radius: 6px;
            padding: 4px;
            display: none;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }

        .context-menu.show {
            display: block;
        }

        .context-item {
            padding: 8px 16px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.9em;
            transition: background 0.15s;
        }

        .context-item:hover {
            background: #333;
        }

        .context-item.disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            align-items: top;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 25px;
            width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid #404040;
        }

        .modal-header h2 {
            color: #4a9eff;
            font-size: 1.4em;
        }

        .close-btn {
            width: 32px;
            height: 32px;
            border-radius: 3px;
            border: none;
            background: #404040;
            font-size: 1.3em;
            cursor: pointer;
            transition: all 0.2s;
            color: #888;
        }

        .close-btn:hover {
            background: #5eff69;
            color: white;
        }

        .param-section {
            margin-bottom: 20px;
        }

        .param-section h3 {
            color: #4a9eff;
            margin-bottom: 12px;
            font-size: 1em;
        }

        .param-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .param {
            display: flex;
            gap: 6px;
            flex-direction: column;
            justify-content: center;
            align-items: stretch;
        }

        .param-label {
            font-weight: 500;
            color: #888;
            font-size: 0.85em;

        }

        .param-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .fader-container {
            display: flex;                  /* 1. Use Flexbox layout */
            justify-content: space-between; /* 2. Push children to opposite ends */
            margin-bottom: 5px;             /* Add a little space before the visual */
        }

        .dropdown-container-1 {
            display: flex;                  /* 1. Use Flexbox layout */
            justify-content: space-between; /* 2. Push children to opposite ends */
            margin-bottom: 5px;             /* Add a little space before the visual */
        }

        .slider {
            flex: 1;
            height: 20px;
            border-radius: 3px;
            background: #404040;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 3px;
            background: #4a9eff;
            cursor: pointer;
        }

        .param-value {
            min-width: 75px;
            text-align: right;
            font-weight: 600;
            color: #4a9eff;
            font-size: 0.9em;
        }

        .envelope-viz {
            width: 100%;
            height: 120px;
            background: #1a1a1a;
            border-radius: 12px;
            margin-top: 10px;
        }

        .modal-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 2px solid #404040;
        }

        .tab-btn {
            padding: 10px 20px;
            border: none;
            background: transparent;
            color: #888;
            cursor: pointer;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            color: #4a9eff;
        }

        .tab-btn.active {
            color: #4a9eff;
            border-bottom-color: #4a9eff;
        }

        .tab-btn.greyed {
            opacity: 0.5;
            /* cursor: not-allowed; */
            /* pointer-events: none; */
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
        
        /* dropdown menu styling */

        .select {
            /* padding: 3px; */
            border: 0px solid #585656;
            border-radius: 3px;
            background: hsl(212, 54%, 37%);
            color: #f2f1f1;
            font-size: 0.9em;
            cursor: pointer;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            font-weight: 500;
        }


        .select option {
            background: #1a1a1a5c;
            color: #e0e0e0;
            padding: 8px;
            font-weight: 500;
            /* ADD THIS */
        }

        /* Hover state for options (limited browser support) */
        .select option:hover {
            background: #4a9eff;
            color: white;
        }

        /* Modulation Slots */
        .mod-slot-container {
            /* display: flex; */
            flex-direction: column;
            /* gap: 12px; */
            align-items: center;
        }

        .mod-slot {
            display: grid;
            grid-template-columns: 30px 1fr 3fr 1fr 12px 10px;
            gap: 3px;
            align-items: center;
            padding: 3px;
            background: #2a2a2a;
            border-radius: 6px;
            border: 1px solid #404040;
        }

        .mod-slot-number {
            font-weight: 600;
            color: #4a9eff;
            text-align: center;
        }

        .mod-remove-btn {
            width: 10px;
            height: 10px;
            border-radius: 3px;
            border: none;
            background: #ff5e5e70;
            color: white;
            cursor: pointer;
            line-height: 0;
            transition: all 0.2s;
            margin-top: -9px;
        }

        .mod-remove-btn:hover {
            background: #ff3e3e;
            transform: scale(1.1);
        }



        .mod-amount {
            position: relative;
            /* Create positioning context */
            display: flex;
            align-items: center;
            height: 20px;
            /* Fixed height for slider */
        }


        .mod-arrow {
            width: 20px;
            height: 20px;
            margin: 0 auto;
            display: block;
        }

        .mod-amount input[type="range"] {
            flex: 1;
        }

        .mod-amount-val {
            position: absolute;
            /* Overlay positioning */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            /* Perfect centering */
            z-index: 2;
            /* Text on top layer */
            font-size: 0.75em;
            font-weight: 700;
            /* Bold so it stands out */
            color: #ffffff;
            /* White text */
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
            /* Shadow for readability */
            pointer-events: none;
            /* Click-through to slider */
            user-select: none;
            /* No text selection */
            white-space: nowrap;
            /* Don't wrap */
            line-height: 1;
        }

        .mod-midicc-config {
            display: grid;
            grid-template-columns: 0px 1fr 14px 1fr 3px;
            /* gap: 8px; */
            padding: 0px 1px 4px 4px;
            background: #2a2a2a;
            border-left: 1px solid #404040;
            border-bottom: 1px solid #404040;
            border-right: 1px solid #404040;
            margin-left: -374px;
            margin-top: -1px;
            border-radius: 0 0 6px 6px;
        }

        .mod-midicc-label {
            color: #888;
            font-size: 0.9em;
            text-align: center;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>BITBOXER</h1>
            <div class="mode-toggle">
                <button class="mode-btn active" data-mode="micro">Bitbox Micro</button>
                <button class="mode-btn" data-mode="mk2">Bitbox mk2</button>
            </div>
        </div>

        <div class="main-content">
            <div class="pad-area">
                <div class="pad-grid" id="padGrid"></div>
                <div class="status-bar" id="statusBar">Ready. Click to select, double-click to edit, right-click for
                    options.</div>
            </div>

            <div class="sidebar">
                <div class="panel">
                    <h3>File Operations</h3>
                    <div class="controls">
                        <button class="btn btn-primary" id="loadBtn">Load Preset</button>
                        <input type="file" id="fileInput" accept=".xml">
                        <button class="btn btn-primary" id="saveBtn">Save Preset</button>
                        <button class="btn" id="newPresetBtn">New Preset</button>
                    </div>
                </div>

                <div class="panel">
                    <h3>Edit effects</h3>
                    <div class="controls">
                        <button class="btn" id="fxBtn">FX Settings</button>
                    </div>
                </div>

                <div class="panel">
                    <h3>Pad Operations</h3>
                    <div class="controls">
                        <button class="btn" id="exportPadBtn" disabled>Export Selected</button>
                        <button class="btn" id="copyPadBtn" disabled>Copy</button>
                        <button class="btn" id="pastePadBtn" disabled>Paste</button>
                        <button class="btn" id="deletePadBtn" disabled>Delete</button>
                    </div>
                </div>

                <div class="panel info-panel">
                    <h3>Quick Guide</h3>
                    <p><strong>Click:</strong> Select pad</p>
                    <p><strong>Ctrl+Click:</strong> Multi-select</p>
                    <p><strong>Double-click:</strong> Edit parameters</p>
                    <p><strong>Right-click:</strong> Context menu</p>
                    <p><strong>Drag:</strong> Move/swap pads</p>
                    <p><strong>Drop files:</strong> Load XML/SFZ/WAV</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu">
        <div class="context-item" id="contextEdit">Edit Pad</div>
        <div class="context-item" id="contextExport">Export Pad</div>
        <div class="context-item" id="contextCopy">Copy</div>
        <div class="context-item" id="contextPaste">Paste</div>
        <div class="context-item" id="contextDelete">Delete</div>
    </div>

    <!-- Edit Modal -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Edit Pad</h2>
                <button class="close-btn" id="closeModal">âœ”</button>
            </div>


            

            
            <!-- Tabs -->
            <div class="modal-tabs">
                <button class="tab-btn active" data-tab="main">Main</button>
                <button class="tab-btn" data-tab="env">Env</button>
                <button class="tab-btn" data-tab="lfo">LFO</button>
                <button class="tab-btn" data-tab="pos">Pos</button>
                <button class="tab-btn" data-tab="gran">Gran</button>
                <button class="tab-btn" data-tab="config">Config</button>
                <button class="tab-btn" data-tab="mod">Mod</button>
            </div>

            <!-- Main Tab -->
            <div class="tab-content active" id="tab-main">
                <div class="param-section">
                    <h3>Main Parameters</h3>
                    <div class="param-grid">

                        <div class="param">
                            <label class="param-label">Cell Mode</label>
                            <select class="select" id="cellmode">
                                <option value="0">Sample</option>
                                <option value="1">Clip</option>
                                <option value="2">Slicer</option>
                                <option value="3">Granular</option>
                            </select>
                        </div>

                        <div class="param">
                            <div class="fader-container">
                                <label class="param-label">Level</label>
                                <span class="param-value" id="gaindb-val">0.0 dB</span>
                            </div>    
                            <div class="param-control">
                                <input type="range" class="slider" id="gaindb" min="-96000" max="12000" value="0">
                            </div>
                        </div>

                        <div class="param">
                            <div class="fader-container">
                                <label class="param-label">Pitch</label>
                                <span class="param-value" id="pitch-val">0.00 st</span>
                            </div>
                            <div class="param-control">
                                <input type="range" class="slider" id="pitch" min="-24000" max="24000" value="0">
                            </div>
                        </div>

                        <div class="param">
                            <div class="fader-container">
                                <label class="param-label">Pan</label>
                                <span class="param-value" id="panpos-val">Center</span>
                            </div>
                            <div class="param-control">
                                <input type="range" class="slider" id="panpos" min="-1000" max="1000" value="0">
                            </div>
                        </div>

                        <div class="param">
                            <div class="fader-container">
                                <label class="param-label">Filter</label>
                                <span class="param-value" id="dualfilcutoff-val">0.0%</span>
                            </div>
                            <div class="param-control">
                                <input type="range" class="slider" id="dualfilcutoff" min="-1000" max="1000" value="0">
                            </div>
                        </div>

                        <div class="param">
                            <div class="fader-container">
                                <label class="param-label">Resonance</label>
                                <span class="param-value" id="res-val">50.0%</span>
                            </div>
                            <div class="param-control">
                                <input type="range" class="slider" id="res" min="0" max="1000" value="500">
                            </div>
                        </div>

                        <div class="param">
                            <div class="fader-container">
                                <label class="param-label">FX1 Send</label>
                                <span class="param-value" id="fx1send-val">0.0%</span>
                            </div>
                            <div class="param-control">
                                <input type="range" class="slider" id="fx1send" min="0" max="1000" value="0">
                            </div>
                        </div>

                        <div class="param">
                            <div class="fader-container">
                                <label class="param-label">FX2 Send</label>
                                <span class="param-value" id="fx2send-val">0.0%</span>
                            </div>
                            <div class="param-control">
                                <input type="range" class="slider" id="fx2send" min="0" max="1000" value="0">
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <!-- Env Tab -->
            <div class="tab-content" id="tab-env">
                <div class="param-section">
                    <h3>Envelope</h3>
                    <canvas class="envelope-viz" id="envelopeCanvas"></canvas>
                    <div class="param-grid">
                
                        <div class="param">
                            <div class="fader-container">
                                <label class="param-label">Attack</label>
                                <span class="param-value" id="envattack-val">0.0%</span>
                            </div>
                            <div class="param-control">
                                <input type="range" class="slider" id="envattack" min="0" max="1000" value="0">
                            </div>
                        </div>
                
                        <div class="param">
                            <div class="fader-container">
                                <label class="param-label">Decay</label>
                                <span class="param-value" id="envdecay-val">0.0%</span>
                            </div>
                            <div class="param-control">
                                <input type="range" class="slider" id="envdecay" min="0" max="1000" value="0">
                            </div>
                        </div>
                
                        <div class="param">
                            <div class="fader-container">
                                <label class="param-label">Sustain</label>
                                <span class="param-value" id="envsus-val">100.0%</span>
                            </div>
                            <div class="param-control">
                                <input type="range" class="slider" id="envsus" min="0" max="1000" value="1000">
                            </div>
                        </div>
                
                        <div class="param">
                            <div class="fader-container">
                                <label class="param-label">Release</label>
                                <span class="param-value" id="envrel-val">20.0%</span>
                            </div>
                            <div class="param-control">
                                <input type="range" class="slider" id="envrel" min="0" max="1000" value="200">
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <!-- LFO Tab -->
            <div class="tab-content" id="tab-lfo">
                <div class="param-section">
                    <h3>LFO Parameters</h3>
                    <div class="param-grid">

                        <div class="param">
                             <label class="param-label">LFO Wave</label>
                            <div class="dropdown-container-1">
                               
                                <select class="select" id="lfowave">
                                    <option value="0">Saw Up</option>
                                    <option value="1">Saw Down</option>
                                    <option value="2">Triangle</option>
                                    <option value="3">Positive Triangle</option>
                                    <option value="4">Sine</option>
                                    <option value="5">Positive Sine</option>
                                    <option value="6">Square</option>
                                    <option value="7">Positive Square</option>
                                    <option value="8">Random</option>
                                </select>
                            </div>
                        </div>

                        <div class="param">
                            <div class="fader-container">
                                <label class="param-label">LFO Rate</label>
                                <span class="param-value" id="lforate-val">10.0%</span>
                            </div>
                            <div class="param-control">
                                <input type="range" class="slider" id="lforate" min="0" max="1000" value="100">
                            </div>
                        </div>

                        <div class="param">
                            <div class="fader-container">
                                <label class="param-label">LFO Depth</label>
                                <span class="param-value" id="lfoamount-val">100.0%</span>
                            </div>
                            <div class="param-control">
                                <input type="range" class="slider" id="lfoamount" min="0" max="1000" value="1000">
                            </div>
                        </div>

                        <div class="param">
                            <label class="param-label">LFO Key Trigger</label>
                            <select class="select" id="lfokeytrig">
                                <option value="0">Off</option>
                                <option value="1">On</option>
                            </select>
                        </div>
                        <div class="param">
                            <label class="param-label">LFO Beat Sync</label>
                            <select class="select" id="lfobeatsync">
                                <option value="0">Off</option>
                                <option value="1">On</option>
                            </select>
                        </div>
                        <div class="param">
                            <label class="param-label">LFO Rate Beat Sync</label>
                            <select class="select" id="lforatebeatsync">
                                <option value="0">8 bars</option>
                                <option value="1">4 bars</option>
                                <option value="2">2 bars</option>
                                <option value="3">1 bar</option>
                                <option value="4">1/2</option>
                                <option value="5">1/2T</option>
                                <option value="6">1/4</option>
                                <option value="7">1/4T</option>
                                <option value="8">1/8</option>
                                <option value="9">1/8T</option>
                                <option value="10">1/16</option>
                                <option value="11">1/16T</option>
                                <option value="12">1/32</option>
                                <option value="13">1/32T</option>
                                <option value="14">1/64</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pos Tab -->
            <div class="tab-content" id="tab-pos">
                <div class="param-section">
                    <h3>Position & Loop</h3>
                    <div class="param-grid">
                        
                        <div class="param">
                            <div class="fader-container">
                                <label class="param-label">Sample Start</label>
                                <span class="param-value" id="samstart-val">0</span>
                            </div>
                            <div class="param-control">
                                <input type="range" class="slider" id="samstart" min="0" max="4294967295" value="0">
                            </div>
                        </div>
                        
                        <div class="param">
                            <div class="fader-container">
                                <label class="param-label">Sample Length</label>
                                <span class="param-value" id="samlen-val">0</span>        
                            </div>
                            <div class="param-control">
                                <input type="range" class="slider" id="samlen" min="0" max="4294967295" value="0">
                            </div>
                        </div>
                        
                        <div class="param">
                            <div class="fader-container">
                                <label class="param-label">Loop Start</label>
                                <span class="param-value" id="loopstart-val">0</span>
                            </div>
                            <div class="param-control">
                                <input type="range" class="slider" id="loopstart" min="0" max="4294967295" value="0">
                            </div>
                        </div>

                        <div class="param">
                            <div class="fader-container">
                                <label class="param-label">Loop End</label>
                                <span class="param-value" id="loopend-val">0</span>
                            </div>
                            <div class="param-control">
                                <input type="range" class="slider" id="loopend" min="0" max="4294967295" value="0">
                            </div>
                        </div>

                        <div class="param">
                            <div class="fader-container">
                                <label class="param-label">Loop Fade Amount</label>
                                <span class="param-value" id="loopfadeamt-val">0.0%</span>
                            </div>    
                            <div class="param-control">
                                <input type="range" class="slider" id="loopfadeamt" min="0" max="1000" value="0">
                            </div>
                        </div>

                        <div>
                            <div class="param">
                                <label class="param-label">Loop Modes</label>
                                <select class="select" id="loopmodes">
                                    <option value="1" selected>Forward</option>
                                    <option value="2">Bidirect</option>
                                    <option value="0">Off</option>
                                </select>
                            </div>
                            <div class="param">
                                <label class="param-label">Reverse</label>
                                <select class="select" id="reverse">
                                    <option value="0">Off</option>
                                    <option value="1">On</option>
                                </select>
                            </div>
                        </div>

                        <div class="param">
                            <div class="fader-container">
                                <label class="param-label">Active Slice</label>
                                <span class="param-value" id="actslice-val">1</span>
                            </div>
                            <div class="param-control">
                                <input type="range" class="slider" id="actslice" min="1" max="512" value="1">
                            </div>
                        </div>

                        <div class="param">
                            <label class="param-label">Loop Mode</label>
                            <select class="select" id="loopmode">
                                <option value="0">Off</option>
                                <option value="1">On</option>
                            </select>
                        </div>

                        <div class="param">
                            <label class="param-label">Slice Seq:</label>
                            <select class="select" id="slicestepmode">
                                <option value="0">None</option>
                                <option value="1">Forward</option>
                                <option value="2">Backwards</option>
                                <option value="3">Random</option>
                                <option value="4">Stagger</option>
                            </select>
                        </div>

                        <div class="param">
                            <label class="param-label">Quant Size</label>
                            <select class="select" id="quantsize">
                                <option value="0">8 bars</option>
                                <option value="1">4 bars</option>
                                <option value="2">2 bars</option>
                                <option value="3">1 bar</option>
                                <option value="4">1/2</option>
                                <option value="5">1/4</option>
                                <option value="6">1/8</option>
                                <option value="7">1/16</option>
                                <option value="8">1/32</option>
                                <option value="9">1/64</option>
                                <option value="10">none</option>
                            </select>
                        </div>
 
                        <div class="param">
                            <label class="param-label">Sync Type</label>
                            <select class="select" id="synctype">
                                <option value="0">Slice</option>
                                <option value="1">1 bar</option>
                                <option value="2">1/2</option>
                                <option value="3">1/4</option>
                                <option value="4">1/8</option>
                                <option value="5">1/16</option>
                                <option value="6">none</option>
                            </select>
                        </div>
 
                        <div class="param">
                            <div class="fader-container">
                                <label class="param-label">Beat Count</label>
                                <span class="param-value" id="beatcount-val">Auto</span>
                            </div>
                            <div class="param-control">
                                <input type="range" class="slider" id="beatcount" min="0" max="512" value="0">
                            </div>
                        </div>
 
                        <div class="param">
                            <label class="param-label">Play Thru</label>
                            <select class="select" id="playthru">
                                <option value="0">Off</option>
                                <option value="1">On</option>
                            </select>
                        </div>
                        <div class="param">
                            <label class="param-label">Slicer Quantize</label>
                            <select class="select" id="slicerquantsize">
                                <option value="0">2 bars</option>
                                <option value="1">1 bar</option>
                                <option value="2">1/2</option>
                                <option value="3">1/2T</option>
                                <option value="4">1/4</option>
                                <option value="5">1/4T</option>
                                <option value="6">1/8</option>
                                <option value="7">1/8T</option>
                                <option value="8">1/16</option>
                                <option value="9">1/16T</option>
                                <option value="10">1/32</option>
                                <option value="11">1/32T</option>
                                <option value="12">1/64</option>
                                <option value="13">none</option>
                            </select>
                        </div>
                        <div class="param">
                            <label class="param-label">Slicer Sync</label>
                            <select class="select" id="slicersync">
                                <option value="0">Off</option>
                                <option value="1">On</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gran Tab -->
            <div class="tab-content" id="tab-gran">
                <div class="param-section">
                    <h3>Granular Parameters</h3>
                    <div class="param-grid">
                        <div class="param">
                            <label class="param-label">Grain Size</label>
                            <div class="param-control">
                                <input type="range" class="slider" id="grainsizeperc" min="0" max="1000" value="300">
                                <span class="param-value" id="grainsizeperc-val">30.0%</span>
                            </div>
                        </div>
                        <div class="param">
                            <label class="param-label">Grain Scatter</label>
                            <div class="param-control">
                                <input type="range" class="slider" id="grainscat" min="0" max="1000" value="0">
                                <span class="param-value" id="grainscat-val">0.0%</span>
                            </div>
                        </div>
                        <div class="param">
                            <label class="param-label">Grain Pan Random</label>
                            <div class="param-control">
                                <input type="range" class="slider" id="grainpanrnd" min="0" max="1000" value="0">
                                <span class="param-value" id="grainpanrnd-val">0.0%</span>
                            </div>
                        </div>
                        <div class="param">
                            <label class="param-label">Grain Density</label>
                            <div class="param-control">
                                <input type="range" class="slider" id="graindensity" min="0" max="1000" value="600">
                                <span class="param-value" id="graindensity-val">60.0%</span>
                            </div>
                        </div>
                        <div class="param">
                            <label class="param-label">Grain Read Speed</label>
                            <div class="param-control">
                                <input type="range" class="slider" id="grainreadspeed" min="0" max="2000" value="1000">
                                <span class="param-value" id="grainreadspeed-val">100.0%</span>
                            </div>
                        </div>
                        <div class="param">
                            <label class="param-label">Grain Source Window</label>
                            <div class="param-control">
                                <input type="range" class="slider" id="gainssrcwin" min="0" max="1000" value="0">
                                <span class="param-value" id="gainssrcwin-val">0.0%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Config Tab -->
            <div class="tab-content" id="tab-config">
                <div class="param-section">
                    <h3>Configuration</h3>
                    <div class="param-grid">


                        <div class="param">
                            <label class="param-label">Launch Mode</label>
                            <select class="select" id="samtrigtype">
                                <option value="0">Gate</option>
                                <option value="1">Trigger</option>
                                <option value="2">Toggle</option>
                            </select>
                        </div>
                        <div class="param">
                            <label class="param-label">Poly Mode</label>
                            <select class="select" id="polymode">
                                <option value="0">Mono</option>
                                <option value="1">Poly 2</option>
                                <option value="2">Poly 4</option>
                                <option value="3">Poly 6</option>
                                <option value="4">Poly 8</option>
                                <option value="5">Poly X</option>
                            </select>
                        </div>
                        <div class="param">
                            <label class="param-label">MIDI Channel</label>
                            <select class="select" id="midimode">
                                <option value="0">None</option>
                                <option value="1">Ch 1 (omni)</option>
                                <option value="2">Ch 2</option>
                                <option value="3">Ch 3</option>
                                <option value="4">Ch 4</option>
                                <option value="5">Ch 5</option>
                                <option value="6">Ch 6</option>
                                <option value="7">Ch 7</option>
                                <option value="8">Ch 8</option>
                                <option value="9">Ch 9</option>
                                <option value="10">Ch 10</option>
                                <option value="11">Ch 11</option>
                                <option value="12">Ch 12</option>
                                <option value="13">Ch 13</option>
                                <option value="14">Ch 14</option>
                                <option value="15">Ch 15</option>
                                <option value="16">Ch 16</option>
                            </select>
                        </div>

                        <div class="param">
                            <label class="param-label">Output Bus</label>
                            <select class="select" id="outputbus">
                                <option value="0">Out1/2</option>
                                <option value="1">Out3/4</option>
                                <option value="2">Out5/6</option>
                                <option value="3">Out7/8</option>
                                <option value="4">Out1</option>
                                <option value="5">Out2</option>
                                <option value="6">Out3</option>
                                <option value="7">Out4</option>
                                <option value="8">Out5</option>
                                <option value="9">Out6</option>
                                <option value="10">Out7</option>
                                <option value="11">Out8</option>
                            </select>
                        </div>
                        <div class="param">
                            <label class="param-label">Excl Group:</label>
                            <select class="select" id="chokegrp">
                                <option value="0">Excl X (Off)</option>
                                <option value="1">Excl A</option>
                                <option value="2">Excl B</option>
                                <option value="3">Excl C</option>
                                <option value="4">Excl D</option>
                            </select>
                        </div>

                        <div class="param">
                            <label class="param-label">Root Note</label>
                            <select class="select" id="rootnote">
                                <option value="0">Off</option>
                                <option value="1">C-1 (0)</option>
                                <option value="2">C#-1 (1)</option>
                                <option value="3">D-1 (2)</option>
                                <option value="4">D#-1 (3)</option>
                                <option value="5">E-1 (4)</option>
                                <option value="6">F-1 (5)</option>
                                <option value="7">F#-1 (6)</option>
                                <option value="8">G-1 (7)</option>
                                <option value="9">G#-1 (8)</option>
                                <option value="10">A-1 (9)</option>
                                <option value="11">A#-1 (10)</option>
                                <option value="12">B-1 (11)</option>
                                <option value="13">C0 (12)</option>
                                <option value="14">C#0 (13)</option>
                                <option value="15">D0 (14)</option>
                                <option value="16">D#0 (15)</option>
                                <option value="17">E0 (16)</option>
                                <option value="18">F0 (17)</option>
                                <option value="19">F#0 (18)</option>
                                <option value="20">G0 (19)</option>
                                <option value="21">G#0 (20)</option>
                                <option value="22">A0 (21)</option>
                                <option value="23">A#0 (22)</option>
                                <option value="24">B0 (23)</option>
                                <option value="25">C1 (24)</option>
                                <option value="26">C#1 (25)</option>
                                <option value="27">D1 (26)</option>
                                <option value="28">D#1 (27)</option>
                                <option value="29">E1 (28)</option>
                                <option value="30">F1 (29)</option>
                                <option value="31">F#1 (30)</option>
                                <option value="32">G1 (31)</option>
                                <option value="33">G#1 (32)</option>
                                <option value="34">A1 (33)</option>
                                <option value="35">A#1 (34)</option>
                                <option value="36">B1 (35)</option>
                                <option value="37">C2 (36)</option>
                                <option value="38">C#2 (37)</option>
                                <option value="39">D2 (38)</option>
                                <option value="40">D#2 (39)</option>
                                <option value="41">E2 (40)</option>
                                <option value="42">F2 (41)</option>
                                <option value="43">F#2 (42)</option>
                                <option value="44">G2 (43)</option>
                                <option value="45">G#2 (44)</option>
                                <option value="46">A2 (45)</option>
                                <option value="47">A#2 (46)</option>
                                <option value="48">B2 (47)</option>
                                <option value="49">C3 (48)</option>
                                <option value="50">C#3 (49)</option>
                                <option value="51">D3 (50)</option>
                                <option value="52">D#3 (51)</option>
                                <option value="53">E3 (52)</option>
                                <option value="54">F3 (53)</option>
                                <option value="55">F#3 (54)</option>
                                <option value="56">G3 (55)</option>
                                <option value="57">G#3 (56)</option>
                                <option value="58">A3 (57)</option>
                                <option value="59">A#3 (58)</option>
                                <option value="60">B3 (59)</option>
                                <option value="61">C4 (60)</option>
                                <option value="62">C#4 (61)</option>
                                <option value="63">D4 (62)</option>
                                <option value="64">D#4 (63)</option>
                                <option value="65">E4 (64)</option>
                                <option value="66">F4 (65)</option>
                                <option value="67">F#4 (66)</option>
                                <option value="68">G4 (67)</option>
                                <option value="69">G#4 (68)</option>
                                <option value="70">A4 (69)</option>
                                <option value="71">A#4 (70)</option>
                                <option value="72">B4 (71)</option>
                                <option value="73">C5 (72)</option>
                                <option value="74">C#5 (73)</option>
                                <option value="75">D5 (74)</option>
                                <option value="76">D#5 (75)</option>
                                <option value="77">E5 (76)</option>
                                <option value="78">F5 (77)</option>
                                <option value="79">F#5 (78)</option>
                                <option value="80">G5 (79)</option>
                                <option value="81">G#5 (80)</option>
                                <option value="82">A5 (81)</option>
                                <option value="83">A#5 (82)</option>
                                <option value="84">B5 (83)</option>
                                <option value="85">C6 (84)</option>
                                <option value="86">C#6 (85)</option>
                                <option value="87">D6 (86)</option>
                                <option value="88">D#6 (87)</option>
                                <option value="89">E6 (88)</option>
                                <option value="90">F6 (89)</option>
                                <option value="91">F#6 (90)</option>
                                <option value="92">G6 (91)</option>
                                <option value="93">G#6 (92)</option>
                                <option value="94">A6 (93)</option>
                                <option value="95">A#6 (94)</option>
                                <option value="96">B6 (95)</option>
                                <option value="97">C7 (96)</option>
                                <option value="98">C#7 (97)</option>
                                <option value="99">D7 (98)</option>
                                <option value="100">D#7 (99)</option>
                                <option value="101">E7 (100)</option>
                                <option value="102">F7 (101)</option>
                                <option value="103">F#7 (102)</option>
                                <option value="104">G7 (103)</option>
                                <option value="105">G#7 (104)</option>
                                <option value="106">A7 (105)</option>
                                <option value="107">A#7 (106)</option>
                                <option value="108">B7 (107)</option>
                                <option value="109">C8 (108)</option>
                                <option value="110">C#8 (109)</option>
                                <option value="111">D8 (110)</option>
                                <option value="112">D#8 (111)</option>
                                <option value="113">E8 (112)</option>
                                <option value="114">F8 (113)</option>
                                <option value="115">F#8 (114)</option>
                                <option value="116">G8 (115)</option>
                                <option value="117">G#8 (116)</option>
                                <option value="118">A8 (117)</option>
                                <option value="119">A#8 (118)</option>
                                <option value="120">B8 (119)</option>
                                <option value="121">C9 (120)</option>
                                <option value="122">C#9 (121)</option>
                                <option value="123">D9 (122)</option>
                                <option value="124">D#9 (123)</option>
                                <option value="125">E9 (124)</option>
                                <option value="126">F9 (125)</option>
                                <option value="127">F#9 (126)</option>
                                <option value="128">G9 (127)</option>
                            </select>
                        </div>
                        <div class="param">
                            <label class="param-label">Legato Mode</label>
                            <select class="select" id="legatomode">
                                <option value="0">Off</option>
                                <option value="1">On</option>
                            </select>
                        </div>
                        <div class="param">
                            <label class="param-label">Interp Quality</label>
                            <select class="select" id="interpqual">
                                <option value="0">Normal</option>
                                <option value="1">High Quality</option>
                            </select>
                        </div>

                    </div>
                </div>
            </div>

            <!-- Mod Tab -->
            <div class="tab-content" id="tab-mod">
                <div class="param-section">
                    <h3>Modulation Sources</h3>
                    <div id="modSlotContainer" class="mod-slot-container">
                        <!-- Mod slots will be dynamically generated here -->
                    </div>
                    <button class="btn" id="addModSlotBtn" style="margin-top: 10px;">+ Add Modulation</button>
                </div>
            </div>

            <!-- Status Bar / console -->
            <div class="status-bar" id="editModalStatusBar"></div>

        </div>
    </div>

    <!-- FX Modal -->
    <div class="modal" id="fxModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Global FX Settings</h2>
                <button class="close-btn" id="closeFxModal">âœ”</button>
            </div>



            <!-- FX Tabs -->
            <div class="modal-tabs">
                <button class="tab-btn active" data-tab="delay">Delay</button>
                <button class="tab-btn" data-tab="reverb">Reverb</button>
                <button class="tab-btn" data-tab="eq">EQ</button>
            </div>

            <!-- Delay Tab -->
            <div class="tab-content active" id="tab-delay">
                <div class="param-section">
                    <h3>Delay Parameters</h3>
                    <div class="param-grid">
                        <div class="param">
                            <label class="param-label">Delay Time (ms)</label>
                            <div class="param-control">
                                <input type="range" class="slider" id="fx-delay" min="0" max="1000" value="400">
                                <span class="param-value" id="fx-delay-val">40.0%</span>
                            </div>
                        </div>
                        <div class="param">
                            <label class="param-label">Delay Time (sync)</label>
                            <select class="select" id="fx-delaymustime">
                                <option value="0">1/64</option>
                                <option value="1">1/32</option>
                                <option value="2">1/16</option>
                                <option value="3">1/8T</option>
                                <option value="4">1/16D</option>
                                <option value="5">1/8</option>
                                <option value="6">1/4T</option>
                                <option value="7" selected>1/8D</option>
                                <option value="8">1/4</option>
                                <option value="9">1/2T</option>
                                <option value="10">1/2</option>
                                <option value="11">1 bar</option>
                            </select>
                        </div>
                        <div class="param">
                            <label class="param-label">Feedback</label>
                            <div class="param-control">
                                <input type="range" class="slider" id="fx-feedback" min="0" max="1000" value="400">
                                <span class="param-value" id="fx-feedback-val">40.0%</span>
                            </div>
                        </div>
                        <div class="param">
                            <label class="param-label">Cutoff</label>
                            <div class="param-control">
                                <input type="range" class="slider" id="fx-cutoff" min="0" max="1000" value="120">
                                <span class="param-value" id="fx-cutoff-val">12.0%</span>
                            </div>
                        </div>
                        <div class="param">
                            <label class="param-label">Filter Quality</label>
                            <div class="param-control">
                                <input type="range" class="slider" id="fx-filtquality" min="0" max="1000" value="1000">
                                <span class="param-value" id="fx-filtquality-val">100.0%</span>
                            </div>
                        </div>
                        <div class="param">
                            <label class="param-label">Beat Sync</label>
                            <select class="select" id="fx-dealybeatsync">
                                <option value="0">Off</option>
                                <option value="1" selected>On</option>
                            </select>
                        </div>
                        <div class="param">
                            <label class="param-label">Filter Enable</label>
                            <select class="select" id="fx-filtenable">
                                <option value="0">Off</option>
                                <option value="1" selected>On</option>
                            </select>
                        </div>
                        <div class="param">
                            <label class="param-label">Ping Pong</label>
                            <select class="select" id="fx-delaypingpong">
                                <option value="0">Off</option>
                                <option value="1" selected>On</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Delay Modulation -->
                <div class="param-section">
                    <h3>Delay Modulation (Max 9 slots)</h3>
                    <div id="fxDelayModContainer" class="mod-slot-container"></div>
                    <button class="btn" id="addDelayModSlotBtn" style="margin-top: 10px;">+ Add Modulation</button>
                </div>
            </div>

            <!-- Reverb Tab -->
            <div class="tab-content" id="tab-reverb">
                <div class="param-section">
                    <h3>Reverb Parameters</h3>
                    <div class="param-grid">
                        <div class="param">
                            <label class="param-label">Decay</label>
                            <div class="param-control">
                                <input type="range" class="slider" id="fx-decay" min="0" max="1000" value="600">
                                <span class="param-value" id="fx-decay-val">60.0%</span>
                            </div>
                        </div>
                        <div class="param">
                            <label class="param-label">Pre-delay</label>
                            <div class="param-control">
                                <input type="range" class="slider" id="fx-predelay" min="0" max="1000" value="40">
                                <span class="param-value" id="fx-predelay-val">4.0%</span>
                            </div>
                        </div>
                        <div class="param">
                            <label class="param-label">Damping</label>
                            <div class="param-control">
                                <input type="range" class="slider" id="fx-damping" min="0" max="1000" value="500">
                                <span class="param-value" id="fx-damping-val">50.0%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reverb Modulation -->
                <div class="param-section">
                    <h3>Reverb Modulation (Max 9 slots)</h3>
                    <div id="fxReverbModContainer" class="mod-slot-container"></div>
                    <button class="btn" id="addReverbModSlotBtn" style="margin-top: 10px;">+ Add Modulation</button>
                </div>
            </div>

            <!-- EQ Tab -->
            <div class="tab-content" id="tab-eq">
                <div class="param-section">
                    <h3>EQ Band 1</h3>
                    <div class="param-grid">
                        <div>
                            <div class="param">
                                <label class="param-label">Type</label>
                                <select class="select" id="fx-eqtype">
                                    <option value="0">None</option>
                                    <option value="1" selected>Low Cut</option>
                                    <option value="2">Low Shelf</option>
                                    <option value="3">Parametric</option>
                                    <option value="4">High Shelf</option>
                                    <option value="5">High Cut</option>
                                </select>
                            </div>
                            <div class="param">
                                <label class="param-label">Enable</label>
                                <select class="select" id="fx-eqenable">
                                    <option value="0">Off</option>
                                    <option value="1" selected>On</option>
                                </select>
                            </div>
                        </div>
                        <div class="param">
                            <label class="param-label">Gain</label>
                            <div class="param-control">
                                <input type="range" class="slider" id="fx-eqgain" min="-24000" max="24000" value="0">
                                <span class="param-value" id="fx-eqgain-val">0.0 dB</span>
                            </div>
                        </div>
                        <div class="param">
                            <label class="param-label">Frequency</label>
                            <div class="param-control">
                                <input type="range" class="slider" id="fx-eqcutoff" min="0" max="1000" value="200">
                                <span class="param-value" id="fx-eqcutoff-val">20.0%</span>
                            </div>
                        </div>
                        <div class="param">
                            <label class="param-label">Q / Width</label>
                            <div class="param-control">
                                <input type="range" class="slider" id="fx-eqres" min="0" max="1000" value="400">
                                <span class="param-value" id="fx-eqres-val">40.0%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Repeat for bands 2, 3, 4 -->
                <div class="param-section">
                    <h3>EQ Band 2</h3>
                    <div class="param-grid">
                        <div class="param">
                            <label class="param-label">Type</label>
                            <select class="select" id="fx-eqtype2">
                                <option value="0">None</option>
                                <option value="1">Low Cut</option>
                                <option value="2">Low Shelf</option>
                                <option value="3" selected>Parametric</option>
                                <option value="4">High Shelf</option>
                                <option value="5">High Cut</option>
                            </select>
                        </div>
                        <div class="param">
                            <label class="param-label">Enable</label>
                            <select class="select" id="fx-eqenable2">
                                <option value="0">Off</option>
                                <option value="1" selected>On</option>
                            </select>
                        </div>
                        <div class="param">
                            <label class="param-label">Gain</label>
                            <div class="param-control">
                                <input type="range" class="slider" id="fx-eqgain2" min="-24000" max="24000" value="0">
                                <span class="param-value" id="fx-eqgain2-val">0.0 dB</span>
                            </div>
                        </div>
                        <div class="param">
                            <label class="param-label">Frequency</label>
                            <div class="param-control">
                                <input type="range" class="slider" id="fx-eqcutoff2" min="0" max="1000" value="400">
                                <span class="param-value" id="fx-eqcutoff2-val">40.0%</span>
                            </div>
                        </div>
                        <div class="param">
                            <label class="param-label">Q / Width</label>
                            <div class="param-control">
                                <input type="range" class="slider" id="fx-eqres2" min="0" max="1000" value="400">
                                <span class="param-value" id="fx-eqres2-val">40.0%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="param-section">
                    <h3>EQ Band 3</h3>
                    <div class="param-grid">
                        <div class="param">
                            <label class="param-label">Type</label>
                            <select class="select" id="fx-eqtype3">
                                <option value="0">None</option>
                                <option value="1">Low Cut</option>
                                <option value="2">Low Shelf</option>
                                <option value="3" selected>Parametric</option>
                                <option value="4">High Shelf</option>
                                <option value="5">High Cut</option>
                            </select>
                        </div>
                        <div class="param">
                            <label class="param-label">Enable</label>
                            <select class="select" id="fx-eqenable3">
                                <option value="0">Off</option>
                                <option value="1" selected>On</option>
                            </select>
                        </div>
                        <div class="param">
                            <label class="param-label">Gain</label>
                            <div class="param-control">
                                <input type="range" class="slider" id="fx-eqgain3" min="-24000" max="24000" value="0">
                                <span class="param-value" id="fx-eqgain3-val">0.0 dB</span>
                            </div>
                        </div>
                        <div class="param">
                            <label class="param-label">Frequency</label>
                            <div class="param-control">
                                <input type="range" class="slider" id="fx-eqcutoff3" min="0" max="1000" value="600">
                                <span class="param-value" id="fx-eqcutoff3-val">60.0%</span>
                            </div>
                        </div>
                        <div class="param">
                            <label class="param-label">Q / Width</label>
                            <div class="param-control">
                                <input type="range" class="slider" id="fx-eqres3" min="0" max="1000" value="400">
                                <span class="param-value" id="fx-eqres3-val">40.0%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="param-section">
                    <h3>EQ Band 4</h3>
                    <div class="param-grid">
                        <div class="param">
                            <label class="param-label">Type</label>
                            <select class="select" id="fx-eqtype4">
                                <option value="0">None</option>
                                <option value="1">Low Cut</option>
                                <option value="2">Low Shelf</option>
                                <option value="3">Parametric</option>
                                <option value="4" selected>High Shelf</option>
                                <option value="5">High Cut</option>
                            </select>
                        </div>
                        <div class="param">
                            <label class="param-label">Enable</label>
                            <select class="select" id="fx-eqenable4">
                                <option value="0">Off</option>
                                <option value="1" selected>On</option>
                            </select>
                        </div>
                        <div class="param">
                            <label class="param-label">Gain</label>
                            <div class="param-control">
                                <input type="range" class="slider" id="fx-eqgain4" min="-24000" max="24000" value="0">
                                <span class="param-value" id="fx-eqgain4-val">0.0 dB</span>
                            </div>
                        </div>
                        <div class="param">
                            <label class="param-label">Frequency</label>
                            <div class="param-control">
                                <input type="range" class="slider" id="fx-eqcutoff4" min="0" max="1000" value="800">
                                <span class="param-value" id="fx-eqcutoff4-val">80.0%</span>
                            </div>
                        </div>
                        <div class="param">
                            <label class="param-label">Q / Width</label>
                            <div class="param-control">
                                <input type="range" class="slider" id="fx-eqres4" min="0" max="1000" value="400">
                                <span class="param-value" id="fx-eqres4-val">40.0%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

                        <!-- Status Bar / console -->
            <div class="status-bar" id="fxModalStatusBar"></div>
        </div>
    </div>



    <script>
        let currentMode = 'micro';
        let presetData = null;
        let selectedPads = new Set();
        let clipboard = null;
        let draggedPad = null;
        let currentEditingPad = null;
        let assetCells = []; // Store asset references

        let greyValue = '0.5'; // set the greyed-out amount

        // Modulation configuration
        const MOD_SOURCES = [
            { value: 'none', label: '--- None ---' },
            { value: 'mod1', label: 'Mod 1' },
            { value: 'mod2', label: 'Mod 2' },
            { value: 'mod3', label: 'Mod 3' },
            { value: 'mod4', label: 'Mod 4' },
            { value: 'mod5', label: 'Mod 5' },
            { value: 'mod6', label: 'Mod 6' },
            { value: 'mod7', label: 'Mod 7' },
            { value: 'mod8', label: 'Mod 8' },
            { value: 'keytrig', label: 'Key Trigger' },
            { value: 'velocity', label: 'Velocity' },
            { value: 'lfo1', label: 'LFO' },
            { value: 'pitchbend', label: 'Pitch Bend' },
            { value: 'modwheel', label: 'Mod Wheel' },
            { value: 'midivol', label: 'MIDI Volume' },
            { value: 'midipan', label: 'MIDI Pan' },
            { value: 'midicc', label: 'MIDI CC' }
        ];

        // Modulation destinations by cell mode
        const MOD_DESTINATIONS = {
            // Mode 0: Sample
            '0': [
                { value: 'none', label: '--- None ---' },
                { group: 'Main', value: 'gaindb', label: 'Level' },
                { group: 'Main', value: 'pitch', label: 'Pitch' },
                { group: 'Main', value: 'dualfilcutoff', label: 'Filter' },
                { group: 'Main', value: 'res', label: 'Resonance' },
                { group: 'Main', value: 'panpos', label: 'Pan' },
                { group: 'Env', value: 'envattack', label: 'Attack' },
                { group: 'Env', value: 'envdecay', label: 'Decay' },
                { group: 'Env', value: 'envrel', label: 'Release' },
                { group: 'Pos', value: 'samstart', label: 'Start' },
                { group: 'Pos', value: 'samlen', label: 'Length' },
                { group: 'Pos', value: 'loopstart', label: 'Loop Start' },
                { group: 'Pos', value: 'loopend', label: 'Loop End' },
                { group: 'LFO', value: 'lforate', label: 'LFO Rate' },
                { group: 'LFO', value: 'lfoamount', label: 'LFO Depth' }
            ],
            // Mode 1: Clip
            '1': [
                { value: 'none', label: '--- None ---' },
                { group: 'Main', value: 'gaindb', label: 'Level' },
                { group: 'Main', value: 'pitch', label: 'Pitch' },
                { group: 'Main', value: 'dualfilcutoff', label: 'Filter' },
                { group: 'Main', value: 'res', label: 'Resonance' },
                { group: 'Main', value: 'panpos', label: 'Pan' },
                { group: 'Env', value: 'envattack', label: 'Attack' },
                { group: 'Env', value: 'envdecay', label: 'Decay' },
                { group: 'Env', value: 'envrel', label: 'Release' },
                { group: 'LFO', value: 'lforate', label: 'LFO Rate' },
                { group: 'LFO', value: 'lfoamount', label: 'LFO Depth' }
            ],
            // Mode 2: Slice
            '2': [
                { value: 'none', label: '--- None ---' },
                { group: 'Main', value: 'gaindb', label: 'Level' },
                { group: 'Main', value: 'pitch', label: 'Pitch' },
                { group: 'Main', value: 'dualfilcutoff', label: 'Filter' },
                { group: 'Main', value: 'res', label: 'Resonance' },
                { group: 'Main', value: 'panpos', label: 'Pan' },
                { group: 'Env', value: 'envattack', label: 'Attack' },
                { group: 'Env', value: 'envdecay', label: 'Decay' },
                { group: 'Env', value: 'envrel', label: 'Release' },
                { group: 'Pos', value: 'actslice', label: 'Active Slice' },
                { group: 'Pos', value: 'slicestepmode', label: 'Slice Seq' },
                { group: 'LFO', value: 'lforate', label: 'LFO Rate' },
                { group: 'LFO', value: 'lfoamount', label: 'LFO Depth' }
            ],
            // Mode 3: Granular
            '3': [
                { value: 'none', label: '--- None ---' },
                { group: 'Main', value: 'gaindb', label: 'Level' },
                { group: 'Main', value: 'pitch', label: 'Pitch' },
                { group: 'Main', value: 'dualfilcutoff', label: 'Filter' },
                { group: 'Main', value: 'res', label: 'Resonance' },
                { group: 'Main', value: 'panpos', label: 'Pan' },
                { group: 'Env', value: 'envattack', label: 'Attack' },
                { group: 'Env', value: 'envdecay', label: 'Decay' },
                { group: 'Env', value: 'envrel', label: 'Release' },
                { group: 'Pos', value: 'samstart', label: 'Start' },
                { group: 'Pos', value: 'samlen', label: 'Length' },
                { group: 'Pos', value: 'loopstart', label: 'Loop Start' },
                { group: 'Pos', value: 'loopend', label: 'Loop End' },
                { group: 'LFO', value: 'lforate', label: 'LFO Rate' },
                { group: 'LFO', value: 'lfoamount', label: 'LFO Depth' },
                { group: 'Gran', value: 'grainreadspeed', label: 'Grain Speed' }
            ]
        };

        function createEmptyPadData() {
            return {
                filename: '',
                type: 'samtempl',
                params: {
                    gaindb: '0',
                    pitch: '0',
                    panpos: '0',
                    samtrigtype: '0',
                    loopmode: '0',
                    loopmodes: '1',
                    midimode: '0',
                    reverse: '0',
                    cellmode: '0',
                    envattack: '0',
                    envdecay: '0',
                    envsus: '1000',
                    envrel: '200',
                    samstart: '0',
                    samlen: '0',
                    loopstart: '0',
                    loopend: '0',
                    quantsize: '3', // Only in Clipmode:
                    // Quant Size: 8 bars, 4 bars, 2 bars, 1 bar, 1/2, 1/4, 1/8, 1/16, 1/32, 1/64, None
                    synctype: '5',  // In Clip-mode only: Sync: 0=Slice, 1=1 bar, 2=1/2, 3=1/4, 4=1/8, 5=1/16, 6=none. 
                    actslice: '1',
                    outputbus: '0',
                    polymode: '0',
                    polymodeslice: '0',

                    slicemode: '0',
                    slicestepmode: '0',
                    chokegrp: '0',
                    dualfilcutoff: '0',
                    res: '500',
                    rootnote: '0',
                    beatcount: '0', // In Slice-mode and Clip-mode: // 0=Auto, 1=1, 2=2, 3=3 ... 512=512
                    fx1send: '0',
                    fx2send: '0',
                    multisammode: '0', // TO-DO: Making a Multi-Sample!
                    interpqual: '0', // Interp: 0=Normal 1=HighQuality
                    playthru: '0', // Only in Slice-mode: 0=off 1=on
                    slicerquantsize: '13',  // Only in Slicemode: 
                    // Quant Size: 2 bars, 1 bar, 1/2, 1/2T, 1/4, 1/4T, 1/8, 1/8T, 1/16, 1/16T, 1/32, 1/32T, 1/64, None
                    slicersync: '0', // Only in Slicemode: 0=off 1=on
                    padnote: '0', // 
                    loopfadeamt: '0',

                    /* LFO */
                    lfowave: '0',
                    lforate: '100',
                    lfoamount: '1000',
                    lfokeytrig: '0',
                    lfobeatsync: '0',
                    lforatebeatsync: '0',

                    /* Granular */
                    graindensity: '600', // Density: min=0.0% max=100.0%
                    grainsizeperc: '300', // Grain Size: min=0.0% max=100.0%
                    gainssrcwin: '0', // Window: min=0.0% max=100.0%
                    grainscat: '0', // Scatter: min=0.0% max=100.0%
                    grainpanrnd: '0', // Pan Rnd: min=0.0% max=100.0%
                    grainreadspeed: '1000', // Speed: min=0.0% max=100.0%

                    /* Legato */
                    legatomode: '0', // Legato: 0=off 1=on // Plays a sample as long as the envelope takes, and pitchshifts one sample like pitchbend.

                    /* Record settings */
                    recinput: '0', // Rec Input: 0="In 1/2" 1="In 1" 2="In 2" 3="Resample"
                    // ingain, // Gain: min=-96.0 dB max=+20.0 dB // Can't find this one, might be bug (experiment)
                    // recautoplay: '0', // RecToPlay: 0=off 1=on // Can't find this one, might be bug (experiment)
                    recpresetlen: '0',
                    recquant: '3',
                    // recmonmode: '1', // Rec Mon: 0=On 1=Auto 2=off // Can't find this one, might be bug (experiment)
                    recmonoutbus: '0',// Mon Output: 0="Out 1/2" 1="Out 3/4" 2="Out 5/6" 3="Out 7/8" 4="Out 1" 5="Out 2" 6="Out 3" 7="Out 4" 8="Out 5" 9="Out 6" 10="Out 7" 11="Out 8"
                    recusethres: '0', // RecThresh: 0=off 1=on // use the record threshold yes or no
                    recthresh: '-20000', // Threshold: min=-96.0 dB max=0dB

                    deftemplate: '1'
                },
                modsources: [],
                slices: []
            };
        }

        // ========================================
        // FX DATA STRUCTURE
        // ========================================

        function createEmptyFXData() {
            return {
                delay: {
                    type: 'delay',
                    params: {
                        delay: '400',
                        delaymustime: '6',
                        feedback: '400',
                        cutoff: '120',
                        filtquality: '1000',
                        dealybeatsync: '1',
                        filtenable: '1',
                        delaypingpong: '1'
                    },
                    modsources: []
                },
                reverb: {
                    type: 'reverb',
                    params: {
                        decay: '600',
                        predelay: '40',
                        damping: '500'
                    },
                    modsources: []
                },
                eq: {
                    type: 'eq',
                    params: {
                        eqactband: '0',
                        eqgain: '0',
                        eqcutoff: '200',
                        eqres: '400',
                        eqenable: '1',
                        eqtype: '0',
                        eqgain2: '0',
                        eqcutoff2: '400',
                        eqres2: '400',
                        eqenable2: '1',
                        eqtype2: '0',
                        eqgain3: '0',
                        eqcutoff3: '600',
                        eqres3: '400',
                        eqenable3: '1',
                        eqtype3: '0',
                        eqgain4: '0',
                        eqcutoff4: '800',
                        eqres4: '400',
                        eqenable4: '1',
                        eqtype4: '0'
                    },
                    modsources: []
                }
            };
        }

        // ========================================
        // FX MODAL FUNCTIONS
        // ========================================

        function openFxModal() {
            if (!presetData.fx) {
                presetData.fx = createEmptyFXData();
            }

            loadFxParamsToModal();

            document.getElementById('fxModal').classList.add('show');

            // Reset tabs
            const fxModal = document.getElementById('fxModal');
            const tabBtns = fxModal.querySelectorAll('.tab-btn');
            const tabContents = fxModal.querySelectorAll('.tab-content');

            tabBtns.forEach(b => b.classList.remove('active'));
            tabContents.forEach(c => c.classList.remove('active'));

            tabBtns[0].classList.add('active');
            tabContents[0].classList.add('active');

            setupFxModalTabs();

            // Apply conditional visibility
            updateDelayConditionalVisibility();
            updateEQConditionalVisibility();
        }

        function closeFxModal() {
            document.getElementById('fxModal').classList.remove('show');
        }

        function setupFxModalTabs() {
            const fxModal = document.getElementById('fxModal');
            const tabBtns = fxModal.querySelectorAll('.tab-btn');
            const tabContents = fxModal.querySelectorAll('.tab-content');

            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    // Remove active from all
                    tabBtns.forEach(b => b.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));

                    // Add active to clicked
                    btn.classList.add('active');
                    const tabId = 'tab-' + btn.dataset.tab;
                    const targetTab = fxModal.querySelector('#' + tabId);
                    if (targetTab) targetTab.classList.add('active');
                });
            });
        }

        function loadFxParamsToModal() {
            if (!presetData.fx) return;

            // Load Delay params
            const delayParams = presetData.fx.delay?.params || createEmptyFXData().delay.params;
            ['delay', 'delaymustime', 'feedback', 'cutoff', 'filtquality', 'dealybeatsync', 'filtenable', 'delaypingpong'].forEach(param => {
                const element = document.getElementById('fx-' + param);
                if (element && delayParams[param] !== undefined) {
                    element.value = delayParams[param];
                    if (element.type === 'range') {
                        updateFxParamDisplay(param, delayParams[param]);
                    }
                }
            });

            // Load Reverb params
            const reverbParams = presetData.fx.reverb?.params || createEmptyFXData().reverb.params;
            ['decay', 'predelay', 'damping'].forEach(param => {
                const element = document.getElementById('fx-' + param);
                if (element && reverbParams[param] !== undefined) {
                    element.value = reverbParams[param];
                    updateFxParamDisplay(param, reverbParams[param]);
                }
            });

            // Load EQ params
            const eqParams = presetData.fx.eq?.params || createEmptyFXData().eq.params;
            ['eqgain', 'eqcutoff', 'eqres', 'eqenable', 'eqtype',
                'eqgain2', 'eqcutoff2', 'eqres2', 'eqenable2', 'eqtype2',
                'eqgain3', 'eqcutoff3', 'eqres3', 'eqenable3', 'eqtype3',
                'eqgain4', 'eqcutoff4', 'eqres4', 'eqenable4', 'eqtype4'].forEach(param => {
                    const element = document.getElementById('fx-' + param);
                    if (element && eqParams[param] !== undefined) {
                        element.value = eqParams[param];
                        if (element.type === 'range') {
                            updateFxParamDisplay(param, eqParams[param]);
                        }
                    }
                });

            // Render FX modulation
            renderFxModSlots('delay');
            renderFxModSlots('reverb');
        }

        function updateFxParamDisplay(param, value) {
            const display = document.getElementById('fx-' + param + '-val');
            if (!display) return;

            const val = parseFloat(value);
            let text = '';

            // Handle EQ gain (dB)
            if (param.startsWith('eqgain')) {
                text = (val >= 0 ? '+' : '') + (val / 1000).toFixed(1) + ' dB';
            }
            // Handle percentages
            else {
                text = (val / 10).toFixed(1) + '%';
            }

            display.textContent = text;
        }

        function createEmptyPreset() {
            presetData = {
                version: '2',
                pads: {},
                tempo: '120',
                fx: createEmptyFXData()
            };
        
            assetCells = [];
        
            for (let row = 0; row < 4; row++) {
                presetData.pads[row] = {};
                for (let col = 0; col < 4; col++) {
                    // IMPORTANT: Call function fresh each time, don't reuse reference
                    presetData.pads[row][col] = createEmptyPadData();
                }
            }
        }

        let projectName = '';

        function generateRandomHex() {
            return Math.floor(Math.random() * 0x10000).toString(16).padStart(4, '0').toUpperCase();
        }

        function initializeProject() {
            const name = prompt('Enter project name (leave blank for random):', '');
            projectName = name.trim() || `Project_${generateRandomHex()}`;
            updateProjectTitle();
        }

        function updateProjectTitle() {
            document.querySelector('h1').textContent = `BITBOXER - ${projectName}`;
        }

        // Modify DOMContentLoaded:
        document.addEventListener('DOMContentLoaded', () => {
            console.log('BITBOXER: Initializing...');
            try {
                createEmptyPreset();
                createPadGrid();
                setupEventListeners();
                initializeProject();
                setupModalTabs();
                setupGlobalDragDrop(); 
                setStatus('Ready');
                console.log('BITBOXER: Ready!');
            } catch (error) {
                console.error('BITBOXER ERROR:', error);
                setStatus('Initialization error - check console', 'error');
            }
        });

        function createPadGrid() {
            const grid = document.getElementById('padGrid');
            grid.innerHTML = '';

            console.log('Creating pad grid...');

            for (let row = 3; row >= 0; row--) {
                for (let col = 0; col < 4; col++) {
                    const padNum = (row * 4) + col + 1;
                    const pad = document.createElement('div');
                    pad.className = 'pad empty';
                    pad.dataset.row = row;
                    pad.dataset.col = col;
                    pad.dataset.padnum = padNum;
                    // pad.draggable = true;

                    pad.setAttribute('draggable', 'true');

                    if (currentMode === 'micro' && row > 1) {
                        pad.classList.add('disabled');
                    }

                    pad.innerHTML = `
                        <span class="pad-number">${padNum}</span>
                        <span class="pad-label">Empty</span>
                        <span class="pad-status"></span>
                    `;

                    setupPadEvents(pad);
                    grid.appendChild(pad);
                }
            }

            console.log('Pad grid created');
        }

        function setupPadEvents(pad) {
            pad.addEventListener('click', (e) => handlePadClick(e, pad));
            pad.addEventListener('dblclick', () => openEditModal(pad));
            pad.addEventListener('contextmenu', (e) => showContextMenu(e, pad));
            pad.addEventListener('dragstart', (e) => {
                console.log('DRAGSTART on pad:', pad.dataset.padnum);
                handleDragStart(e, pad);
            });
            pad.addEventListener('dragover', (e) => {
                handleDragOver(e, pad);
            });
            pad.addEventListener('drop', (e) => {
                console.log('DROP on pad:', pad.dataset.padnum);
                handleDrop(e, pad);
            });
            pad.addEventListener('dragend', () => {
                console.log('DRAGEND');
                pad.classList.remove('dragging');
                document.querySelectorAll('.pad.drag-over').forEach(p => p.classList.remove('drag-over'));
            });
            pad.addEventListener('dragleave', () => pad.classList.remove('drag-over'));
        }

        // ========================================
        // GLOBAL DRAG & DROP PREVENTION
        // ========================================

        function setupGlobalDragDrop() {
            // Prevent default drag behaviors on the entire page
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                document.body.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            // Add visual feedback for dragging over page
            document.body.addEventListener('dragover', () => {
                document.body.style.backgroundColor = '#252525';
            });

            document.body.addEventListener('dragleave', () => {
                document.body.style.backgroundColor = '#1a1a1a';
            });

            document.body.addEventListener('drop', () => {
                document.body.style.backgroundColor = '#1a1a1a';
            });

            // Handle drops on the body (outside pads)
            document.body.addEventListener('drop', (e) => {
                e.preventDefault();

                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];

                    if (file.name.endsWith('.xml')) {
                        // Ask user if they want to load preset
                        if (confirm(`Load preset from ${file.name}? This will replace the current preset.`)) {
                            loadPreset(file);
                        }
                    } else {
                        setStatus(`Unsupported file type: ${file.name}. Please drop .xml preset files.`, 'error');
                    }
                }
            });
        }


        function handlePadClick(e, pad) {
            if (e.ctrlKey || e.metaKey) {
                togglePadSelection(pad);
            } else {
                clearPadSelection();
                selectPad(pad);
            }
            updateButtonStates();
        }

        function selectPad(pad) {
            pad.classList.add('selected');
            selectedPads.add(pad.dataset.padnum);
        }

        function togglePadSelection(pad) {
            if (pad.classList.contains('selected')) {
                pad.classList.remove('selected');
                selectedPads.delete(pad.dataset.padnum);
            } else {
                selectPad(pad);
            }
        }

        function clearPadSelection() {
            document.querySelectorAll('.pad.selected').forEach(p => p.classList.remove('selected'));
            selectedPads.clear();
        }

        function updateButtonStates() {
            const hasSelection = selectedPads.size > 0;
            document.getElementById('exportPadBtn').disabled = !hasSelection;
            document.getElementById('copyPadBtn').disabled = !hasSelection;
            document.getElementById('deletePadBtn').disabled = !hasSelection;
            document.getElementById('pastePadBtn').disabled = !clipboard;
        }

        function handleDragStart(e, pad) {
            draggedPad = pad;
            pad.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', pad.dataset.padnum);
        }

        function handleDragOver(e, pad) {
            e.preventDefault();
            e.stopPropagation();
            e.dataTransfer.dropEffect = 'move';
            if (draggedPad && draggedPad !== pad) {
                pad.classList.add('drag-over');
            }
        }

        function handleDrop(e, pad) {
            e.preventDefault();
            e.stopPropagation();
            pad.classList.remove('drag-over');

            if (e.dataTransfer.files.length > 0) {
                handleFileDropOnPad(e.dataTransfer.files[0], pad);
            } else if (draggedPad && draggedPad !== pad) {
                console.log('Swapping pads:', draggedPad.dataset.padnum, 'with', pad.dataset.padnum);
                swapPads(draggedPad, pad);
            }

            if (draggedPad) {
                draggedPad.classList.remove('dragging');
                draggedPad = null;
            }
        }

        function swapPads(pad1, pad2) {
            const row1 = parseInt(pad1.dataset.row);
            const col1 = parseInt(pad1.dataset.col);
            const row2 = parseInt(pad2.dataset.row);
            const col2 = parseInt(pad2.dataset.col);

            // Swap the data
            const temp = presetData.pads[row1][col1];
            presetData.pads[row1][col1] = presetData.pads[row2][col2];
            presetData.pads[row2][col2] = temp;

            // Update asset references with proper type conversion
            assetCells.forEach(asset => {
                const assetRow = parseInt(asset.params.asssrcrow);
                const assetCol = parseInt(asset.params.asssrccol);

                if (assetRow === row1 && assetCol === col1) {
                    asset.params.asssrcrow = String(row2);
                    asset.params.asssrccol = String(col2);
                } else if (assetRow === row2 && assetCol === col2) {
                    asset.params.asssrcrow = String(row1);
                    asset.params.asssrccol = String(col1);
                }
            });

            // Force visual update by recreating the pad display
            updatePadDisplay();

            setStatus(`Swapped Pad ${pad1.dataset.padnum} with Pad ${pad2.dataset.padnum}`, 'success');
        }

        function handleFileDropOnPad(file, pad) {
            if (file.name.endsWith('.xml')) {
                if (confirm(`Load preset from ${file.name}? All current pads will be lost!`)) {
                    loadPreset(file);
                }
            } else if (file.name.endsWith('.json')) {
                loadPadFromJSON(file, pad);
            } else if (file.name.endsWith('.sfz')) {
                setStatus('SFZ import coming soon!');
            } else if (file.name.endsWith('.wav')) {
                setStatus('WAV import coming soon!');
            }
        }

        async function loadPadFromJSON(file, targetPad) {
            try {
                const text = await file.text();
                const padData = JSON.parse(text);

                const row = parseInt(targetPad.dataset.row);
                const col = parseInt(targetPad.dataset.col);

                if (padData.data) {
                    presetData.pads[row][col] = JSON.parse(JSON.stringify(padData.data));
                    updatePadDisplay();
                    setStatus(`Loaded pad from ${file.name}`, 'success');
                } else {
                    setStatus('Invalid pad JSON format', 'error');
                }
            } catch (error) {
                setStatus(`Error loading pad: ${error.message}`, 'error');
            }
        }

        function createModSlotHTML(modData, index, cellmode) {
            const destinations = MOD_DESTINATIONS[cellmode] || MOD_DESTINATIONS['0'];

            const sourceOptions = MOD_SOURCES.map(src =>
                `<option value="${src.value}" ${modData.src === src.value ? 'selected' : ''}>${src.label}</option>`
            ).join('');

            const destOptions = destinations.map(dest =>
                `<option value="${dest.value}" ${modData.dest === dest.value ? 'selected' : ''}>${dest.label}</option>`
            ).join('');

            const amount = parseInt(modData.amount) || 0;
            const amountText = (amount >= 0 ? '+' : '') + (amount / 10).toFixed(1) + '%';

            const slotLabel = `${index + 1}`;

            // Check if this slot uses MIDI CC
            const isMidiCC = modData.src === 'midicc';
            const midiChannel = modData.mchan !== undefined ? parseInt(modData.mchan) : 0;
            const midiCCNum = modData.ccnum !== undefined ? parseInt(modData.ccnum) : 0;

            // Generate MIDI channel options (1-16)
            let channelOptions = '';
            for (let i = 0; i < 16; i++) {
                channelOptions += `<option value="${i}" ${midiChannel === i ? 'selected' : ''}>Ch ${i + 1}</option>`;
            }

            // Generate CC number options (0-127)
            let ccOptions = '';
            for (let i = 0; i <= 127; i++) {
                ccOptions += `<option value="${i}" ${midiCCNum === i ? 'selected' : ''}>CC ${i}</option>`;
            }

            return `
                <div class="mod-slot" data-slot="${index}">
                    <div class="mod-slot-number" title="Slot ${index + 1}">${slotLabel}</div>
                    <select class="select mod-source" data-slot="${index}">
                        ${sourceOptions}
                    </select>
                   <div class="mod-amount">
                        <input type="range" class="slider mod-amount-slider" data-slot="${index}" 
                               min="-1000" max="1000" value="${amount}">
                        <span class="mod-amount-val" data-slot="${index}">${amountText}</span>
                    </div>
                    

                    <select class="select mod-dest" data-slot="${index}">
                        ${destOptions}
                    </select>
                    <div></div>
                    <button class="mod-remove-btn" data-slot="${index}">Ã—</button>
                    
                </div>
                
                <div class="mod-midicc-config" data-slot="${index}" style="display: ${isMidiCC ? 'grid' : 'none'};">
                    <div></div>
                    <select class="select mod-midicc-channel" data-slot="${index}">
                        ${channelOptions}
                    </select>
                    <span class="mod-midicc-label">+</span>
                    <select class="select mod-midicc-ccnum" data-slot="${index}">
                        ${ccOptions}
                    </select>
                    <div></div> <div></div>
                </div>
            `;
        }

        // ========================================
        // FX MODULATION FUNCTIONS
        // ========================================

        // FX Modulation destinations
        const FX_MOD_DESTINATIONS = {
            delay: [
                { value: 'none', label: '--- None ---' },
                { value: 'delaymustime', label: 'Delay Time' },
                { value: 'feedback', label: 'Feedback' },
                { value: 'cutoff', label: 'Cutoff' }
            ],
            reverb: [
                { value: 'none', label: '--- None ---' },
                { value: 'decay', label: 'Decay' },
                { value: 'predelay', label: 'Pre-delay' },
                { value: 'damping', label: 'Damping' }
            ]
        };

        function createFxModSlotHTML(modData, index, fxType) {
            const destinations = FX_MOD_DESTINATIONS[fxType] || [];

            const sourceOptions = MOD_SOURCES.map(src =>
                `<option value="${src.value}" ${modData.src === src.value ? 'selected' : ''}>${src.label}</option>`
            ).join('');

            const destOptions = destinations.map(dest =>
                `<option value="${dest.value}" ${modData.dest === dest.value ? 'selected' : ''}>${dest.label}</option>`
            ).join('');

            const amount = parseInt(modData.amount) || 0;
            const amountText = (amount >= 0 ? '+' : '') + (amount / 10).toFixed(1) + '%';

            const slotLabel = `${index + 1}`;

            // Check if this slot uses MIDI CC
            const isMidiCC = modData.src === 'midicc';
            const midiChannel = modData.mchan !== undefined ? parseInt(modData.mchan) : 0;
            const midiCCNum = modData.ccnum !== undefined ? parseInt(modData.ccnum) : 0;

            // Generate MIDI channel options (1-16)
            let channelOptions = '';
            for (let i = 0; i < 16; i++) {
                channelOptions += `<option value="${i}" ${midiChannel === i ? 'selected' : ''}>Ch ${i + 1}</option>`;
            }

            // Generate CC number options (0-127)
            let ccOptions = '';
            for (let i = 0; i <= 127; i++) {
                ccOptions += `<option value="${i}" ${midiCCNum === i ? 'selected' : ''}>CC ${i}</option>`;
            }

            return `
                <div class="mod-slot" data-slot="${index}" data-fx-type="${fxType}">
                    <div class="mod-slot-number" title="Slot ${index + 1}">${slotLabel}</div>
                    <select class="select fx-mod-source" data-slot="${index}" data-fx-type="${fxType}">
                        ${sourceOptions}
                    </select>
                    <span class="mod-arrow">â†’</span>
                    <select class="select fx-mod-dest" data-slot="${index}" data-fx-type="${fxType}">
                        ${destOptions}
                    </select>
                    <div class="mod-amount">
                        <input type="range" class="slider fx-mod-amount-slider" data-slot="${index}" data-fx-type="${fxType}"
                               min="-1000" max="1000" value="${amount}">
                        <span class="mod-amount-val" data-slot="${index}">${amountText}</span>
                    </div>
                    <button class="mod-remove-btn fx-mod-remove" data-slot="${index}" data-fx-type="${fxType}">Ã—</button>
                </div>
                <div class="mod-midicc-config" data-slot="${index}" style="display: ${isMidiCC ? 'grid' : 'none'};">
                    <div></div>
                    <select class="select fx-mod-midicc-channel" data-slot="${index}" data-fx-type="${fxType}">
                        ${channelOptions}
                    </select>
                    <span class="mod-midicc-label">+</span>
                    <select class="select fx-mod-midicc-ccnum" data-slot="${index}" data-fx-type="${fxType}">
                        ${ccOptions}
                    </select>
                    <div></div>
                    <div></div>
                </div>
            `;
        }

        function renderFxModSlots(fxType) {
            const containerId = fxType === 'delay' ? 'fxDelayModContainer' : 'fxReverbModContainer';
            const container = document.getElementById(containerId);
            if (!container) return;

            container.innerHTML = '';

            if (!presetData.fx || !presetData.fx[fxType]) return;

            const modsources = presetData.fx[fxType].modsources || [];

            modsources.forEach((mod, index) => {
                container.innerHTML += createFxModSlotHTML(mod, index, fxType);
            });

            setupFxModSlotListeners();

            // Apply initial appearance to all slots
            document.querySelectorAll('.fx-mod-source').forEach(sourceSelect => {
                const slotElement = sourceSelect.closest('.mod-slot');
                if (slotElement) updateFxModSlotAppearance(slotElement);
            });
        }

        function setupFxModSlotListeners() {
            // Source dropdowns
            document.querySelectorAll('.fx-mod-source').forEach(select => {
                select.addEventListener('change', (e) => {
                    const slot = parseInt(e.target.dataset.slot);
                    const fxType = e.target.dataset.fxType;
                    const newSource = e.target.value;

                    if (!presetData.fx || !presetData.fx[fxType]) return;

                    if (!presetData.fx[fxType].modsources[slot]) {
                        presetData.fx[fxType].modsources[slot] = { dest: 'none', src: 'none', slot: '0', amount: '0' };
                    }

                    // Update source
                    presetData.fx[fxType].modsources[slot].src = newSource;

                    // appearance updates after source changes
                    const slotElement = e.target.closest('.mod-slot');
                    if (slotElement) updateFxModSlotAppearance(slotElement);

                    // Show/hide MIDI CC config
                    // const slotElement = e.target.closest('.mod-slot');
                    const midiccConfig = slotElement?.nextElementSibling;
                    if (midiccConfig && midiccConfig.classList.contains('mod-midicc-config')) {
                        if (newSource === 'midicc') {
                            midiccConfig.style.display = 'grid';
                            if (!presetData.fx[fxType].modsources[slot].mchan) presetData.fx[fxType].modsources[slot].mchan = '0';
                            if (!presetData.fx[fxType].modsources[slot].ccnum) presetData.fx[fxType].modsources[slot].ccnum = '0';
                        } else {
                            midiccConfig.style.display = 'none';
                            delete presetData.fx[fxType].modsources[slot].mchan;
                            delete presetData.fx[fxType].modsources[slot].ccnum;
                        }
                    }
                });
            });

            // MIDI CC Channel dropdowns
            document.querySelectorAll('.fx-mod-midicc-channel').forEach(select => {
                select.addEventListener('change', (e) => {
                    const slot = parseInt(e.target.dataset.slot);
                    const fxType = e.target.dataset.fxType;
                    if (presetData.fx && presetData.fx[fxType] && presetData.fx[fxType].modsources[slot]) {
                        presetData.fx[fxType].modsources[slot].mchan = e.target.value;
                    }
                });
            });

            // MIDI CC Number dropdowns
            document.querySelectorAll('.fx-mod-midicc-ccnum').forEach(select => {
                select.addEventListener('change', (e) => {
                    const slot = parseInt(e.target.dataset.slot);
                    const fxType = e.target.dataset.fxType;
                    if (presetData.fx && presetData.fx[fxType] && presetData.fx[fxType].modsources[slot]) {
                        presetData.fx[fxType].modsources[slot].ccnum = e.target.value;
                    }
                });
            });

            // Destination dropdowns
            document.querySelectorAll('.fx-mod-dest').forEach(select => {
                select.addEventListener('change', (e) => {
                    const slot = parseInt(e.target.dataset.slot);
                    const fxType = e.target.dataset.fxType;
                    const newDest = e.target.value;

                    // Validate destination limit (skip validation for 'none')
                    if (newDest !== 'none') {
                        const validation = validateFxModDestination(fxType, newDest, slot);

                        if (!validation.valid) {
                            setStatus(`Maximum 3 modulations per destination! ${newDest} already has 3 slots.`, 'error');
                            // Revert to previous value
                            const previousDest = presetData.fx[fxType].modsources[slot]?.dest || 'none';
                            e.target.value = previousDest;
                            return;
                        }
                    }

                    if (presetData.fx && presetData.fx[fxType] && presetData.fx[fxType].modsources[slot]) {
                        presetData.fx[fxType].modsources[slot].dest = newDest;
                    }

                    // In destination dropdown listener, after updating data:
                    const slotElement = e.target.closest('.mod-slot');
                    if (slotElement) updateFxModSlotAppearance(slotElement);

                });
            });

            // Amount sliders
            document.querySelectorAll('.fx-mod-amount-slider').forEach(slider => {
                slider.addEventListener('input', (e) => {
                    const slot = parseInt(e.target.dataset.slot);
                    const fxType = e.target.dataset.fxType;
                    const amount = e.target.value;

                    if (presetData.fx && presetData.fx[fxType] && presetData.fx[fxType].modsources[slot]) {
                        presetData.fx[fxType].modsources[slot].amount = amount;
                    }

                    // Update display
                    const slotElement = e.target.closest('.mod-slot');
                    const display = slotElement?.querySelector('.mod-amount-val');
                    if (display) {
                        const amountText = (amount >= 0 ? '+' : '') + (amount / 10).toFixed(1) + '%';
                        display.textContent = amountText;
                    }
                });
            });

            // Remove buttons
            document.querySelectorAll('.fx-mod-remove').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const slot = parseInt(e.target.dataset.slot);
                    const fxType = e.target.dataset.fxType;

                    if (presetData.fx && presetData.fx[fxType] && presetData.fx[fxType].modsources) {
                        presetData.fx[fxType].modsources.splice(slot, 1);
                        renderFxModSlots(fxType);
                    }
                });
            });
        }

        function addFxModSlot(fxType) {
            if (!presetData.fx || !presetData.fx[fxType]) return;

            if (!presetData.fx[fxType].modsources) presetData.fx[fxType].modsources = [];

            if (presetData.fx[fxType].modsources.length >= 9) {
                setStatus(`Maximum 9 modulation slots for ${fxType}`, 'error');
                return;
            }

            const newSlot = {
                dest: 'none',
                src: 'velocity',
                slot: presetData.fx[fxType].modsources.length.toString(),
                amount: '400'
            };

            presetData.fx[fxType].modsources.push(newSlot);
            renderFxModSlots(fxType);
        }

        function updateFxModSlotAppearance(slotElement) {
            const sourceSelect = slotElement.querySelector('.fx-mod-source');
            const destSelect = slotElement.querySelector('.fx-mod-dest');

            if (!sourceSelect || !destSelect) return;

            const isActive = sourceSelect.value !== 'none' && destSelect.value !== 'none';

            // Update opacity
            slotElement.style.opacity = isActive ? '1' : '0.5';

            // Add/remove inactive class
            if (isActive) {
                slotElement.classList.remove('inactive');
            } else {
                slotElement.classList.add('inactive');
            }
        }


        function validateModDestination(destValue, currentSlotIndex) {
            if (!currentEditingPad || !presetData) return { valid: true, count: 0 };

            const row = parseInt(currentEditingPad.dataset.row);
            const col = parseInt(currentEditingPad.dataset.col);
            const padData = presetData.pads[row][col];

            if (!padData.modsources) return { valid: true, count: 0 };

            // Count how many slots already target this destination (excluding current slot)
            const count = padData.modsources.filter((mod, index) =>
                mod.dest === destValue && index !== currentSlotIndex
            ).length;

            return {
                valid: count < 3,
                count: count,
                remaining: 3 - count
            };
        }

        function validateFxModDestination(fxType, destValue, currentSlotIndex) {
            if (!presetData.fx || !presetData.fx[fxType]) return { valid: true, count: 0 };

            const modsources = presetData.fx[fxType].modsources || [];

            // Count how many slots already target this destination (excluding current slot)
            const count = modsources.filter((mod, index) =>
                mod.dest === destValue && index !== currentSlotIndex
            ).length;

            return {
                valid: count < 3,
                count: count,
                remaining: 3 - count
            };
        }

        function renderModSlots(padData) {
            const container = document.getElementById('modSlotContainer');
            if (!container) return;

            container.innerHTML = '';

            const cellmode = padData.params.cellmode || '0';
            const modsources = padData.modsources || [];

            // Render existing mod slots
            modsources.forEach((mod, index) => {
                container.innerHTML += createModSlotHTML(mod, index, cellmode);
            });

            // Setup event listeners for all slots
            setupModSlotListeners();

            // Apply initial appearance to all slots
            document.querySelectorAll('.mod-slot').forEach(slotElement => {
                updateModSlotAppearance(slotElement);
            });
        }

        function setupModSlotListeners() {
            // Source dropdowns - EXPANDED VERSION
            document.querySelectorAll('.mod-source').forEach(select => {
                select.addEventListener('change', (e) => {
                    const slot = parseInt(e.target.dataset.slot);
                    const newSource = e.target.value;

                    if (!currentEditingPad || !presetData) return;

                    const row = parseInt(currentEditingPad.dataset.row);
                    const col = parseInt(currentEditingPad.dataset.col);
                    const padData = presetData.pads[row][col];

                    if (!padData.modsources[slot]) {
                        padData.modsources[slot] = { dest: 'none', src: 'none', slot: '0', amount: '0' };
                    }

                    // Update source
                    padData.modsources[slot].src = newSource;

                    // Show/hide MIDI CC config
                    const midiccConfig = document.querySelector(`.mod-midicc-config[data-slot="${slot}"]`);
                    if (midiccConfig) {
                        if (newSource === 'midicc') {
                            midiccConfig.style.display = 'grid';
                            // Set defaults if not already set
                            if (!padData.modsources[slot].mchan) padData.modsources[slot].mchan = '0';
                            if (!padData.modsources[slot].ccnum) padData.modsources[slot].ccnum = '0';
                        } else {
                            midiccConfig.style.display = 'none';
                            // Remove MIDI CC data
                            delete padData.modsources[slot].mchan;
                            delete padData.modsources[slot].ccnum;
                        }
                    }

                    // Update appearance
                    const slotElement = e.target.closest('.mod-slot');
                    if (slotElement) updateModSlotAppearance(slotElement);
                });
            });

            // MIDI CC Channel dropdowns - ADD THIS NEW SECTION
            document.querySelectorAll('.mod-midicc-channel').forEach(select => {
                select.addEventListener('change', (e) => {
                    const slot = parseInt(e.target.dataset.slot);
                    updateModSlot(slot, 'mchan', e.target.value);
                });
            });

            // MIDI CC Number dropdowns - ADD THIS NEW SECTION
            document.querySelectorAll('.mod-midicc-ccnum').forEach(select => {
                select.addEventListener('change', (e) => {
                    const slot = parseInt(e.target.dataset.slot);
                    updateModSlot(slot, 'ccnum', e.target.value);
                });
            });

            // Destination dropdowns
            document.querySelectorAll('.mod-dest').forEach(select => {
                select.addEventListener('change', (e) => {
                    const slot = parseInt(e.target.dataset.slot);
                    const newDest = e.target.value;

                    // Validate destination limit (skip validation for 'none')
                    if (newDest !== 'none') {
                        const validation = validateModDestination(newDest, slot);

                        if (!validation.valid) {
                            setStatus(`Maximum 3 modulations per destination! ${newDest} already has 3 slots.`, 'error');
                            // Revert to previous value
                            const row = parseInt(currentEditingPad.dataset.row);
                            const col = parseInt(currentEditingPad.dataset.col);
                            const previousDest = presetData.pads[row][col].modsources[slot]?.dest || 'none';
                            e.target.value = previousDest;
                            return;
                        }
                    }

                    updateModSlot(slot, 'dest', newDest);

                    // Update appearance immediately
                    const slotElement = e.target.closest('.mod-slot');
                    if (slotElement) updateModSlotAppearance(slotElement);

                    // Update slot number in data to match destination's slot count
                    if (newDest !== 'none') {
                        const row = parseInt(currentEditingPad.dataset.row);
                        const col = parseInt(currentEditingPad.dataset.col);
                        const destSlotNum = presetData.pads[row][col].modsources.filter((mod, idx) =>
                            mod.dest === newDest && idx <= slot
                        ).length - 1;
                        updateModSlot(slot, 'slot', destSlotNum.toString());
                    }
                });
            });

            // Amount sliders
            document.querySelectorAll('.mod-amount-slider').forEach(slider => {
                slider.addEventListener('input', (e) => {
                    const slot = parseInt(e.target.dataset.slot);
                    const amount = e.target.value;
                    updateModSlot(slot, 'amount', amount);

                    // Update display
                    const display = document.querySelector(`.mod-amount-val[data-slot="${slot}"]`);
                    if (display) {
                        const amountText = (amount >= 0 ? '+' : '') + (amount / 10).toFixed(1) + '%';
                        display.textContent = amountText;
                    }
                });
            });

            // Remove buttons
            document.querySelectorAll('.mod-remove-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const slot = parseInt(e.target.dataset.slot);
                    removeModSlot(slot);
                });
            });
        }

        function updateModSlot(slot, field, value) {
            if (!currentEditingPad || !presetData) return;

            const row = parseInt(currentEditingPad.dataset.row);
            const col = parseInt(currentEditingPad.dataset.col);
            const padData = presetData.pads[row][col];

            if (!padData.modsources[slot]) {
                padData.modsources[slot] = { dest: 'none', src: 'none', slot: '0', amount: '0' };
            }

            padData.modsources[slot][field] = value.toString();

            // Auto-update the destination slot number when dest changes
            if (field === 'dest' && value !== 'none') {
                // Count how many slots before this one target the same destination
                const destSlotNum = padData.modsources.filter((mod, idx) =>
                    mod.dest === value && idx <= slot
                ).length - 1;
                padData.modsources[slot].slot = destSlotNum.toString();
            }
        }

        function removeModSlot(slot) {
            if (!currentEditingPad || !presetData) return;

            const row = parseInt(currentEditingPad.dataset.row);
            const col = parseInt(currentEditingPad.dataset.col);
            const padData = presetData.pads[row][col];

            padData.modsources.splice(slot, 1);

            // Re-render
            renderModSlots(padData);
        }

        function addModSlot() {
            if (!currentEditingPad || !presetData) return;

            const row = parseInt(currentEditingPad.dataset.row);
            const col = parseInt(currentEditingPad.dataset.col);
            const padData = presetData.pads[row][col];

            if (!padData.modsources) padData.modsources = [];

            if (padData.modsources.length >= 12) {
                setStatus('Maximum 12 modulation slots per pad', 'error');
                return;
            }

            const newSlot = {
                dest: 'gaindb',
                src: 'velocity',
                slot: '0', // Will be recalculated when destination is set
                amount: '0'
            };

            // Check if gaindb already has 3 slots
            const validation = validateModDestination('gaindb', -1);
            if (!validation.valid) {
                // Default to 'none' if gaindb is full
                newSlot.dest = 'none';
                newSlot.src = 'none';
                setStatus('Added slot with no destination (default gaindb is full)', 'success');
            }

            padData.modsources.push(newSlot);
            renderModSlots(padData);
        }

        function updateModSlotAppearance(slotElement) {
            const slotIndex = slotElement.dataset.slot;
            const sourceSelect = slotElement.querySelector('.mod-source');
            const destSelect = slotElement.querySelector('.mod-dest');

            if (!sourceSelect || !destSelect) return;

            const isActive = sourceSelect.value !== 'none' && destSelect.value !== 'none';

            // Update opacity
            slotElement.style.opacity = isActive ? '1' : '0.5';

            // Optionally add/remove a class for more styling control
            if (isActive) {
                slotElement.classList.remove('inactive');
            } else {
                slotElement.classList.add('inactive');
            }
        }

        function setupEventListeners() {
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentMode = btn.dataset.mode;
                    createPadGrid();
                    updatePadDisplay();

                    // If FX modal is open, update EQ visibility
                    if (document.getElementById('fxModal').classList.contains('show')) {
                        updateEQConditionalVisibility();
                    }
                });
            });

            document.getElementById('loadBtn').addEventListener('click', () => document.getElementById('fileInput').click());
            document.getElementById('fileInput').addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    if (confirm(`Load preset? All current pads will be lost!`)) {
                        loadPreset(e.target.files[0]);
                    }
                }
                e.target.value = ''; // Reset file input
            });

            document.getElementById('saveBtn').addEventListener('click', savePreset);
            document.getElementById('newPresetBtn').addEventListener('click', () => {
                if (confirm('Create new preset? All current pads will be lost!')) {
                    createEmptyPreset();
                    initializeProject(); // ADD THIS
                    updatePadDisplay();
                    setStatus('New preset created');
                }
            });

            document.getElementById('exportPadBtn').addEventListener('click', exportSelectedPads);
            document.getElementById('copyPadBtn').addEventListener('click', copySelectedPads);
            document.getElementById('pastePadBtn').addEventListener('click', pasteToSelected);
            document.getElementById('deletePadBtn').addEventListener('click', deleteSelectedPads);

            document.getElementById('closeModal').addEventListener('click', closeEditModal);
            document.getElementById('editModal').addEventListener('click', (e) => {
                if (e.target.id === 'editModal') closeEditModal();
            });

            document.addEventListener('click', (e) => {
                if (!e.target.closest('.context-menu')) {
                    hideContextMenu();
                }
            });

            // FX Modal controls
            document.getElementById('fxBtn').addEventListener('click', openFxModal);
            document.getElementById('closeFxModal').addEventListener('click', closeFxModal);
            document.getElementById('fxModal').addEventListener('click', (e) => {
                if (e.target.id === 'fxModal') closeFxModal();
            });

            // FX modulation add buttons
            document.getElementById('addDelayModSlotBtn').addEventListener('click', () => addFxModSlot('delay'));
            document.getElementById('addReverbModSlotBtn').addEventListener('click', () => addFxModSlot('reverb'));

            // Setup FX parameter listeners
            setupFxParameterListeners();


            setupParameterListeners();
            setupDragDrop();

            document.getElementById('addModSlotBtn').addEventListener('click', addModSlot);
        }

        function setupModalTabs() {
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');

            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    // Remove active from all
                    tabBtns.forEach(b => b.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));

                    // Add active to clicked
                    btn.classList.add('active');
                    const tabId = 'tab-' + btn.dataset.tab;
                    document.getElementById(tabId).classList.add('active');

                    // Redraw envelope if on Env tab
                    if (btn.dataset.tab === 'env') {
                        drawEnvelope();
                    }
                });
            });
        }

        function updateTabVisibility() {
            const cellmode = document.getElementById('cellmode').value;
            const granTab = document.querySelector('[data-tab="gran"]');
            const posTab = document.querySelector('[data-tab="pos"]');
            const lfoTab = document.querySelector('[data-tab="lfo"]');

            // Get the actual tab content panels
            const granContent = document.getElementById('tab-gran');
            const posContent = document.getElementById('tab-pos');

            // Reset all tabs to visible/enabled
            [granTab, posTab, lfoTab].forEach(tab => {
                tab.style.display = '';
                tab.style.opacity = '1';
            });
            [granContent, posContent].forEach(content => {
                if (content) {
                    content.style.opacity = '1';
                    content.style.pointerEvents = '';

                }
            });

            // Hide/disable based on cellmode
            // 0=Sample, 1=Clip, 2=Slice, 3=Granular
            switch (cellmode) {
                case '0': // Sample mode - hide Gran
                    granTab.style.opacity = greyValue;
                    granContent.style.opacity = greyValue;

                    break;
                case '1': // Clip mode - grey out Gran, grey out Pos
                    granTab.style.opacity = greyValue;
                    granContent.style.opacity = greyValue;
                    // if (posContent) {
                    //     posContent.style.opacity = greyValue;
                    //     granContent.style.opacity = greyValue;
                    // };
                    break;
                case '2': // Slice mode - hide Gran
                    granTab.style.opacity = greyValue;
                    granContent.style.opacity = greyValue;
                    // posTab.style.opacity = '1';

                    //     posContent.style.opacity = '1';

                    break;
                case '3': // Granular mode - all available
                    break;
            }
        }

        function updatePosConditionalVisibility() {
            const cellmode = document.getElementById('cellmode').value;
            const loopmodes = document.getElementById('loopmodes').value;

            // Get all Pos tab parameters
            const samstartParam = document.getElementById('samstart')?.closest('.param');
            const samlenParam = document.getElementById('samlen')?.closest('.param');
            const loopstartParam = document.getElementById('loopstart')?.closest('.param');
            const loopendParam = document.getElementById('loopend')?.closest('.param');
            const loopfadeamtParam = document.getElementById('loopfadeamt')?.closest('.param');
            const loopmodesParam = document.getElementById('loopmodes')?.closest('.param');
            const loopmode = document.getElementById('loopmode')?.closest('.param');
            const actsliceParam = document.getElementById('actslice')?.closest('.param');
            const slicestepmode = document.getElementById('slicestepmode')?.closest('.param');
            const reverseParam = document.getElementById('reverse')?.closest('.param');

            // Clip mode params
            const quantsizeParam = document.getElementById('quantsize')?.closest('.param');
            const synctypeParam = document.getElementById('synctype')?.closest('.param');
            const beatcountParam = document.getElementById('beatcount')?.closest('.param');

            // Slice mode params
            const playthruParam = document.getElementById('playthru')?.closest('.param');
            const slicerquantsizeParam = document.getElementById('slicerquantsize')?.closest('.param');
            const slicersyncParam = document.getElementById('slicersync')?.closest('.param');

            // Reset all to visible and fully opaque
            [samstartParam, samlenParam, loopstartParam, loopendParam, loopfadeamtParam,
                loopmodesParam, loopmode, actsliceParam, slicestepmode, reverseParam,
                quantsizeParam, synctypeParam, beatcountParam, playthruParam,
                slicerquantsizeParam, slicersyncParam].forEach(param => {
                    if (param) {
                        param.style.opacity = '1';
                    }
                });

            // Apply greying based on cellmode
            switch (cellmode) {
                case '0': // Sample mode - grey out slice and clip specific
                    if (actsliceParam) actsliceParam.style.opacity = greyValue;
                    if (slicestepmode) slicestepmode.style.opacity = greyValue;
                    if (loopmode) loopmode.style.opacity = greyValue;
                    if (quantsizeParam) quantsizeParam.style.opacity = greyValue;
                    if (synctypeParam) synctypeParam.style.opacity = greyValue;
                    if (beatcountParam) beatcountParam.style.opacity = greyValue;
                    if (playthruParam) playthruParam.style.opacity = greyValue;
                    if (slicerquantsizeParam) slicerquantsizeParam.style.opacity = greyValue;
                    if (slicersyncParam) slicersyncParam.style.opacity = greyValue;
                    break;

                case '1': // Clip mode - grey out sample/loop and slice specific
                    if (samstartParam) samstartParam.style.opacity = greyValue;
                    if (samlenParam) samlenParam.style.opacity = greyValue;
                    if (loopstartParam) loopstartParam.style.opacity = greyValue;
                    if (loopendParam) loopendParam.style.opacity = greyValue;
                    if (loopfadeamtParam) loopfadeamtParam.style.opacity = greyValue;
                    if (loopmodesParam) loopmodesParam.style.opacity = greyValue;
                    if (actsliceParam) actsliceParam.style.opacity = greyValue;
                    if (slicestepmode) slicestepmode.style.opacity = greyValue;
                    if (reverseParam) reverseParam.style.opacity = greyValue;
                    if (loopmode) loopmode.style.opacity = greyValue;
                    if (playthruParam) playthruParam.style.opacity = greyValue;
                    if (slicerquantsizeParam) slicerquantsizeParam.style.opacity = greyValue;
                    if (slicersyncParam) slicersyncParam.style.opacity = greyValue;
                    break;

                case '2': // Slice mode - grey out sample-specific and clip-specific
                    if (samstartParam) samstartParam.style.opacity = greyValue;
                    if (samlenParam) samlenParam.style.opacity = greyValue;
                    if (loopstartParam) loopstartParam.style.opacity = greyValue;
                    if (loopendParam) loopendParam.style.opacity = greyValue;
                    if (loopfadeamtParam) loopfadeamtParam.style.opacity = greyValue;
                    if (loopmodesParam) loopmodesParam.style.opacity = greyValue;
                    if (reverseParam) reverseParam.style.opacity = greyValue;
                    if (quantsizeParam) quantsizeParam.style.opacity = greyValue;
                    if (synctypeParam) synctypeParam.style.opacity = greyValue;
                    break;

                case '3': // Granular mode - grey out slice-specific and clip-specific
                    if (actsliceParam) actsliceParam.style.opacity = greyValue;
                    if (slicestepmode) slicestepmode.style.opacity = greyValue;
                    if (loopmode) loopmode.style.opacity = greyValue;
                    if (quantsizeParam) quantsizeParam.style.opacity = greyValue;
                    if (synctypeParam) synctypeParam.style.opacity = greyValue;
                    if (beatcountParam) beatcountParam.style.opacity = greyValue;
                    if (playthruParam) playthruParam.style.opacity = greyValue;
                    if (slicerquantsizeParam) slicerquantsizeParam.style.opacity = greyValue;
                    if (slicersyncParam) slicersyncParam.style.opacity = greyValue;
                    break;
            }

            // Additional: grey out loop params when Loop Modes = None (for Sample/Granular)
            if ((cellmode === '0' || cellmode === '3') && loopmodes === '0') {
                if (loopstartParam) loopstartParam.style.opacity = greyValue;
                if (loopendParam) loopendParam.style.opacity = greyValue;
                if (loopfadeamtParam) loopfadeamtParam.style.opacity = greyValue;
            }
        }

        // ========================================
        // FX CONDITIONAL VISIBILITY
        // ========================================

        function updateDelayConditionalVisibility() {
            const beatSync = document.getElementById('fx-dealybeatsync')?.value;
            const filterEnable = document.getElementById('fx-filtenable')?.value;

            // Delay time parameters
            const delayMsParam = document.getElementById('fx-delay')?.closest('.param');
            const delaySyncParam = document.getElementById('fx-delaymustime')?.closest('.param');

            // Filter parameters
            const cutoffParam = document.getElementById('fx-cutoff')?.closest('.param');
            const filtQualityParam = document.getElementById('fx-filtquality')?.closest('.param');

            // Reset all to visible
            [delayMsParam, delaySyncParam, cutoffParam, filtQualityParam].forEach(param => {
                if (param) param.style.opacity = '1';
            });

            // Apply greying based on Beat Sync
            if (beatSync === '1') {
                // Beat Sync ON - grey out ms time
                if (delayMsParam) delayMsParam.style.opacity = greyValue;
            } else {
                // Beat Sync OFF - grey out sync time
                if (delaySyncParam) delaySyncParam.style.opacity = greyValue;
            }

            // Apply greying based on Filter Enable
            if (filterEnable === '0') {
                // Filter OFF - grey out filter params
                if (cutoffParam) cutoffParam.style.opacity = greyValue;
                if (filtQualityParam) filtQualityParam.style.opacity = greyValue;
            }
        }

        function updateEQConditionalVisibility() {
            // Check if Bitbox Micro mode
            const isMicroMode = currentMode === 'micro';
            
            // Get EQ tab button
            const fxModal = document.getElementById('fxModal');
            const eqTabBtn = fxModal?.querySelector('[data-tab="eq"]');
            
            // Get all EQ section headers
            const eqHeaders = fxModal?.querySelectorAll('#tab-eq .param-section h3');
            
            // Get all EQ parameters
            const eqParams = [];
            for (let i = 1; i <= 4; i++) {
                const suffix = i === 1 ? '' : i.toString();
                eqParams.push(
                    document.getElementById(`fx-eqtype${suffix}`)?.closest('.param'),
                    document.getElementById(`fx-eqenable${suffix}`)?.closest('.param'),
                    document.getElementById(`fx-eqgain${suffix}`)?.closest('.param'),
                    document.getElementById(`fx-eqcutoff${suffix}`)?.closest('.param'),
                    document.getElementById(`fx-eqres${suffix}`)?.closest('.param')
                );
            }
            
            // Reset everything to normal
            if (eqTabBtn) {
                eqTabBtn.classList.remove('greyed');
            }
            if (eqHeaders) {
                eqHeaders.forEach(h => h.style.opacity = '1');
            }
            eqParams.forEach(param => {
                if (param) param.style.opacity = '1';
            });
            
            // If Micro mode, grey out entire EQ tab
            if (isMicroMode) {
                if (eqTabBtn) {
                    eqTabBtn.classList.add('greyed');
                }
                if (eqHeaders) {
                    eqHeaders.forEach(h => h.style.opacity = greyValue);
                }
                eqParams.forEach(param => {
                    if (param) param.style.opacity = greyValue;
                });
                return; // Don't process individual bands
            }
            
            // Process each band individually (only if not Micro mode)
            for (let i = 1; i <= 4; i++) {
                const suffix = i === 1 ? '' : i.toString();
                const typeSelect = document.getElementById(`fx-eqtype${suffix}`);
                const enableParam = document.getElementById(`fx-eqenable${suffix}`)?.closest('.param');
                const gainParam = document.getElementById(`fx-eqgain${suffix}`)?.closest('.param');
                const cutoffParam = document.getElementById(`fx-eqcutoff${suffix}`)?.closest('.param');
                const resParam = document.getElementById(`fx-eqres${suffix}`)?.closest('.param');
                
                // Always grey out Enable
                if (enableParam) enableParam.style.opacity = greyValue;
                
                // If Type is "None", grey out Gain, Frequency, Q
                if (typeSelect?.value === '0') {
                    if (gainParam) gainParam.style.opacity = greyValue;
                    if (cutoffParam) cutoffParam.style.opacity = greyValue;
                    if (resParam) resParam.style.opacity = greyValue;
                }
            }
        }

        // Conditional LFO parameter visibilaty
        function updateLFOParameterVisibility() {
            const lfobeatsync = document.getElementById('lfobeatsync').value;
            const lforateParam = document.getElementById('lforate').closest('.param');
            const lforatebeatsyncParam = document.getElementById('lforatebeatsync').closest('.param');

            if (lfobeatsync === '1') {
                // Beat Sync ON - grey out Hz rate, show beat sync
                lforateParam.style.opacity = greyValue;
                lforateParam.style.pointerEvents = '';
                lforatebeatsyncParam.style.opacity = '1';
                lforatebeatsyncParam.style.pointerEvents = '';
            } else {
                // Beat Sync OFF - show Hz rate, grey out beat sync
                lforateParam.style.opacity = '1';
                lforateParam.style.pointerEvents = '';
                lforatebeatsyncParam.style.opacity = greyValue;
                lforatebeatsyncParam.style.pointerEvents = '';
            }
        }

        function setupDragDrop() {
            const grid = document.getElementById('padGrid');
            grid.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'copy';
            });
        }

        function showContextMenu(e, pad) {
            e.preventDefault();

            // Don't deselect if right-clicking on already selected pad
            if (!pad.classList.contains('selected')) {
                clearPadSelection();
                selectPad(pad);
            }

            const menu = document.getElementById('contextMenu');
            menu.style.left = e.pageX + 'px';
            menu.style.top = e.pageY + 'px';
            menu.classList.add('show');

            document.getElementById('contextEdit').onclick = () => {
                openEditModal(pad);
                hideContextMenu();
            };
            document.getElementById('contextExport').onclick = () => {
                exportSelectedPads();
                hideContextMenu();
            };
            document.getElementById('contextCopy').onclick = () => {
                copySelectedPads();
                hideContextMenu();
            };
            document.getElementById('contextPaste').onclick = () => {
                pasteToSelected();
                hideContextMenu();
            };
            document.getElementById('contextDelete').onclick = () => {
                deleteSelectedPads();
                hideContextMenu();
            };

            updateButtonStates();
        }

        function hideContextMenu() {
            document.getElementById('contextMenu').classList.remove('show');
        }

        function setupParameterListeners() {
            const params = [
                'gaindb',
                'pitch',
                'panpos',
                'dualfilcutoff',
                'res',
                'envattack',
                'envdecay',
                'envsus',
                'envrel',
                'lforate',
                'lfoamount',
                'samstart',
                'samlen',
                'loopstart',
                'loopend',
                'loopfadeamt',
                'loopmodes', // forward, bidirectional
                'loopmode', // flag to set loop on Slice mode
                'actslice',
                'grainsizeperc',
                'grainscat',
                'grainpanrnd',
                'graindensity',
                'grainreadspeed',
                'gainssrcwin',
                'rootnote',
                'fx1send',
                'fx2send',
                'legatomode',
                'interpqual',
                'beatcount'
            ];

            params.forEach(param => {
                const slider = document.getElementById(param);
                const display = document.getElementById(param + '-val');

                if (slider && display) {
                    // Slider input
                    slider.addEventListener('input', () => {
                        updateParamDisplay(param, slider.value);
                        if (currentEditingPad && presetData) {
                            const row = parseInt(currentEditingPad.dataset.row);
                            const col = parseInt(currentEditingPad.dataset.col);
                            presetData.pads[row][col].params[param] = slider.value;
                        }
                        if (param.startsWith('env')) drawEnvelope();
                    });

                    // Make display editable
                    display.style.cursor = 'text';
                    display.contentEditable = true;
                    display.addEventListener('blur', () => {
                        const value = parseDisplayValue(param, display.textContent);
                        if (value !== null) {
                            slider.value = value;
                            updateParamDisplay(param, value);
                            if (currentEditingPad && presetData) {
                                const row = parseInt(currentEditingPad.dataset.row);
                                const col = parseInt(currentEditingPad.dataset.col);
                                presetData.pads[row][col].params[param] = value;
                            }
                            if (param.startsWith('env')) drawEnvelope();
                        }
                    });
                    display.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            display.blur();
                        }
                    });
                    // Add mouse wheel support (with explicit non-passive flag)
                    display.addEventListener('wheel', (e) => {
                        e.preventDefault();
                        const currentVal = parseInt(slider.value);
                        const step = e.shiftKey ? 100 : 10; // Hold shift for bigger steps
                        const newVal = currentVal + (e.deltaY < 0 ? step : -step);
                        const clampedVal = Math.max(parseInt(slider.min), Math.min(parseInt(slider.max), newVal));

                        slider.value = clampedVal;
                        updateParamDisplay(param, clampedVal);

                        if (currentEditingPad && presetData) {
                            const row = parseInt(currentEditingPad.dataset.row);
                            const col = parseInt(currentEditingPad.dataset.col);
                            presetData.pads[row][col].params[param] = clampedVal;
                        }
                        if (param.startsWith('env')) drawEnvelope();
                    }, { passive: false });

                    // Touch support for mobile
                    let touchStartY = 0;
                    let touchStartValue = 0;

                    display.addEventListener('touchstart', (e) => {
                        touchStartY = e.touches[0].clientY;
                        touchStartValue = parseInt(slider.value);
                        e.preventDefault();
                    }, { passive: false });

                    display.addEventListener('touchmove', (e) => {
                        const touchY = e.touches[0].clientY;
                        const deltaY = touchStartY - touchY; // Inverted: swipe up = increase
                        const sensitivity = 2; // Adjust sensitivity
                        const step = Math.floor(deltaY / sensitivity);

                        const newVal = touchStartValue + step * 10;
                        const clampedVal = Math.max(parseInt(slider.min), Math.min(parseInt(slider.max), newVal));

                        slider.value = clampedVal;
                        updateParamDisplay(param, clampedVal);

                        if (currentEditingPad && presetData) {
                            const row = parseInt(currentEditingPad.dataset.row);
                            const col = parseInt(currentEditingPad.dataset.col);
                            presetData.pads[row][col].params[param] = clampedVal;
                        }
                        if (param.startsWith('env')) drawEnvelope();

                        e.preventDefault();
                    }, { passive: false });
                }
            });

            // Dropdowns
            ['cellmode',
                'loopmodes',
                'loopmode',
                'samtrigtype',
                'polymode',
                'lfowave',
                'lfokeytrig',
                'lfobeatsync',
                'lforatebeatsync',
                'midimode',
                'reverse',
                'outputbus',
                'chokegrp',
                'slicestepmode',
                'legatomode',
                'interpqual',
                'quantsize',
                'synctype',
                'playthru',
                'slicerquantsize',
                'slicersync'].forEach(param => {
                    const select = document.getElementById(param);
                    if (select) {
                        select.addEventListener('change', () => {
                            if (currentEditingPad && presetData) {
                                const row = parseInt(currentEditingPad.dataset.row);
                                const col = parseInt(currentEditingPad.dataset.col);
                                presetData.pads[row][col].params[param] = select.value;
                            }
                            if (param === 'cellmode') {
                                updateTabVisibility();
                            }
                            if (param === 'lfobeatsync') {
                                updateLFOParameterVisibility();
                            }
                            if (param === 'cellmode' || param === 'loopmodes') {
                                updateTabVisibility();
                                updatePosConditionalVisibility();
                            }
                            if (param === 'cellmode') {
                                updateTabVisibility();
                                // Refresh mod destinations
                                if (currentEditingPad) {
                                    const row = parseInt(currentEditingPad.dataset.row);
                                    const col = parseInt(currentEditingPad.dataset.col);
                                    renderModSlots(presetData.pads[row][col]);
                                }
                            }

                        });
                    }
                });
        }

        // ========================================
        // FX PARAMETER LISTENERS
        // ========================================

        function setupFxParameterListeners() {
            // Delay sliders
            ['delay', 'feedback', 'cutoff', 'filtquality'].forEach(param => {
                const slider = document.getElementById('fx-' + param);
                const display = document.getElementById('fx-' + param + '-val');

                if (slider && display) {
                    slider.addEventListener('input', () => {
                        updateFxParamDisplay(param, slider.value);
                        if (presetData.fx && presetData.fx.delay) {
                            presetData.fx.delay.params[param] = slider.value;
                        }
                    });
                }
            });

            // Delay dropdowns
            ['delaymustime', 'dealybeatsync', 'filtenable', 'delaypingpong'].forEach(param => {
                const select = document.getElementById('fx-' + param);
                if (select) {
                    select.addEventListener('change', () => {
                        if (presetData.fx && presetData.fx.delay) {
                            presetData.fx.delay.params[param] = select.value;
                        }
                    });
                }
            });

            // Add after Delay dropdowns section:
            ['dealybeatsync', 'filtenable'].forEach(param => {
                const select = document.getElementById('fx-' + param);
                if (select) {
                    select.addEventListener('change', () => {
                        if (presetData.fx && presetData.fx.delay) {
                            presetData.fx.delay.params[param] = select.value;
                        }
                        updateDelayConditionalVisibility(); // ADD THIS
                    });
                }
            });

            // Reverb sliders
            ['decay', 'predelay', 'damping'].forEach(param => {
                const slider = document.getElementById('fx-' + param);
                const display = document.getElementById('fx-' + param + '-val');

                if (slider && display) {
                    slider.addEventListener('input', () => {
                        updateFxParamDisplay(param, slider.value);
                        if (presetData.fx && presetData.fx.reverb) {
                            presetData.fx.reverb.params[param] = slider.value;
                        }
                    });
                }
            });

            // EQ sliders (all 4 bands)
            ['eqgain', 'eqcutoff', 'eqres', 'eqgain2', 'eqcutoff2', 'eqres2',
                'eqgain3', 'eqcutoff3', 'eqres3', 'eqgain4', 'eqcutoff4', 'eqres4'].forEach(param => {
                    const slider = document.getElementById('fx-' + param);
                    const display = document.getElementById('fx-' + param + '-val');

                    if (slider && display) {
                        slider.addEventListener('input', () => {
                            updateFxParamDisplay(param, slider.value);
                            if (presetData.fx && presetData.fx.eq) {
                                presetData.fx.eq.params[param] = slider.value;
                            }
                        });
                    }
                });

            // EQ dropdowns (all 4 bands)
            ['eqtype', 'eqenable', 'eqtype2', 'eqenable2',
                'eqtype3', 'eqenable3', 'eqtype4', 'eqenable4'].forEach(param => {
                    const select = document.getElementById('fx-' + param);
                    if (select) {
                        select.addEventListener('change', () => {
                            if (presetData.fx && presetData.fx.eq) {
                                presetData.fx.eq.params[param] = select.value;
                            }
                        });
                    }
                });

            // Add after EQ dropdowns section:
            ['eqtype', 'eqtype2', 'eqtype3', 'eqtype4'].forEach(param => {
                const select = document.getElementById('fx-' + param);
                if (select) {
                    select.addEventListener('change', () => {
                        if (presetData.fx && presetData.fx.eq) {
                            presetData.fx.eq.params[param] = select.value;
                        }
                        updateEQConditionalVisibility(); // ADD THIS
                    });
                }
            });

        }

        function parseDisplayValue(param, text) {
            text = text.trim().replace(/[^\d.-]/g, '');
            const val = parseFloat(text);
            if (isNaN(val)) return null;

            switch (param) {
                case 'gaindb':
                case 'pitch':
                    return Math.round(val * 1000);
                case 'panpos':
                case 'dualfilcutoff':
                case 'res':
                case 'envattack':
                case 'envdecay':
                case 'envsus':
                case 'envrel':
                    return Math.round(val * 10);
                default:
                    return Math.round(val);
                case 'lforate':
                    // User types Hz, convert back to 0-1000
                    const hz = parseFloat(text);
                    if (isNaN(hz) || hz < 0.1 || hz > 12) return null;
                    return Math.round(((hz - 0.1) / 11.9) * 1000);
                case 'lfoamount':
                case 'loopfadeamt':
                case 'grainsizeperc':
                case 'grainscat':
                case 'grainpanrnd':
                case 'graindensity':
                case 'grainreadspeed':
                case 'gainssrcwin':
                case 'fx1send':
                case 'fx2send':
                    text = (val / 10).toFixed(1) + '%';
                    break;
                case 'samstart':
                case 'samlen':
                case 'loopstart':
                case 'loopend':
                    // Parse integer, remove commas and "samples" text
                    const cleaned = text.replace(/[,\s]/g, '').replace(/samples?/i, '');
                    const num = parseInt(cleaned, 10);
                    if (isNaN(num) || num < 0 || num > 4294967295) return null;
                    return num;
                case 'actslice':
                    text = val.toString();
                    break;
                case 'rootnote':
                    const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
                    const octave = Math.floor(val / 12) - 1;
                    const note = notes[val % 12];
                    text = `${note}${octave} (${val})`;
                    break;
                case 'beatcount':
                    const trimmed = text.trim();
                    if (trimmed.toLowerCase() === 'auto') return 0;
                    const num2 = parseInt(trimmed, 10);
                    if (isNaN(num2) || num2 < 0 || num2 > 512) return null;
                    return num2;
            }
        }

        function updateParamDisplay(param, value) {
            const display = document.getElementById(param + '-val');
            if (!display) return;

            const val = parseFloat(value);
            let text = '';

            switch (param) {
                case 'gaindb':
                    text = (val >= 0 ? '+' : '') + (val / 1000).toFixed(1) + ' dB';
                    break;
                case 'pitch':
                    text = (val >= 0 ? '+' : '') + (val / 1000).toFixed(2) + ' st';
                    break;
                case 'panpos':
                    if (val === 0) text = 'Center';
                    else if (val < 0) text = 'L ' + Math.abs(val / 10).toFixed(1) + '%';
                    else text = 'R ' + (val / 10).toFixed(1) + '%';
                    break;
                case 'lforate':
                    // Map 0-1000 to 0.1-12 Hz (logarithmic scale feels more natural)
                    const minHz = 0.1;
                    const maxHz = 12;
                    const normalizedVal = val / 1000; // 0 to 1
                    const hz = minHz + (normalizedVal * (maxHz - minHz));
                    text = hz.toFixed(2) + ' Hz';
                    break;
                case 'beatcount':
                    if (val === 0) {
                        text = 'Auto';
                    } else {
                        text = val.toString();
                    }
                    break;
                case 'samstart':
                case 'samlen':
                case 'loopstart':
                case 'loopend':
                    // Display as sample count, not percentage
                    text = parseInt(val).toLocaleString() + ' samples';
                    break;
                default:
                    text = (val / 10).toFixed(1) + '%';
            }
            display.textContent = text;
        }

        function drawEnvelope() {
            const canvas = document.getElementById('envelopeCanvas');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const width = canvas.width = canvas.offsetWidth;
            const height = canvas.height = canvas.offsetHeight;

            ctx.clearRect(0, 0, width, height);

            const attack = parseFloat(document.getElementById('envattack').value) / 1000;
            const decay = parseFloat(document.getElementById('envdecay').value) / 1000;
            const sustain = parseFloat(document.getElementById('envsus').value) / 1000;
            const release = parseFloat(document.getElementById('envrel').value) / 1000;

            ctx.strokeStyle = '#4a9eff';
            ctx.lineWidth = 2;
            ctx.beginPath();

            const pad = 15;
            const w = width - pad * 2;
            const h = height - pad * 2;

            const total = attack + decay + 0.4 + release;
            const ax = (attack / total) * w;
            const dx = (decay / total) * w;
            const sx = (0.4 / total) * w;
            const rx = (release / total) * w;

            ctx.moveTo(pad, pad + h);
            ctx.lineTo(pad + ax, pad);
            ctx.lineTo(pad + ax + dx, pad + h * (1 - sustain));
            ctx.lineTo(pad + ax + dx + sx, pad + h * (1 - sustain));
            ctx.lineTo(pad + ax + dx + sx + rx, pad + h);

            ctx.stroke();
        }

        function openEditModal(pad) {
            const row = parseInt(pad.dataset.row);
            const col = parseInt(pad.dataset.col);
            const padData = presetData.pads[row][col];

            if (!padData) return;

            // Temporarily null to prevent writes during load
            const tempCurrentPad = currentEditingPad;
            currentEditingPad = null;

            document.getElementById('modalTitle').textContent =
                `Pad ${pad.dataset.padnum} - ${padData.filename || 'Empty'}`;

            loadParamsToModal(padData);

            // NOW set the current editing pad
            currentEditingPad = pad;

            // FORCE render modulation slots with fresh data.
            // Call renderModSlots(padData) right before showing the modal to ensure fresh rendering.
            renderModSlots(padData);

            // Show modal
            document.getElementById('editModal').classList.add('show');

            // Reset tabs to default (Main active)
            const editModal = document.getElementById('editModal');
            const tabBtns = editModal.querySelectorAll('.tab-btn');
            const tabContents = editModal.querySelectorAll('.tab-content');

            // Remove all active classes
            tabBtns.forEach(b => b.classList.remove('active'));
            tabContents.forEach(c => c.classList.remove('active'));

            // Activate first tab (Main)
            tabBtns[0].classList.add('active');
            tabContents[0].classList.add('active');

            drawEnvelope();
            updateTabVisibility();
            updateLFOParameterVisibility();  
            updatePosConditionalVisibility();
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('show');
            currentEditingPad = null;
            updatePadDisplay();
        }

        function loadParamsToModal(padData) {
            const params = padData.params;

            // Sliders
            [
                'gaindb',
                'pitch',
                'panpos',
                'dualfilcutoff',
                'res',
                'envattack',
                'envdecay',
                'envsus',
                'envrel',
                'lforate',
                'lfoamount',
                'samstart',
                'samlen',
                'loopstart',
                'loopend',
                'loopfadeamt',
                'actslice',
                'grainsizeperc',
                'grainscat',
                'grainpanrnd',
                'graindensity',
                'grainreadspeed',
                'gainssrcwin',
                'rootnote',
                'fx1send',
                'fx2send',
                'beatcount'].forEach(param => {
                    const slider = document.getElementById(param);
                    if (slider && params[param] !== undefined) {
                        slider.value = params[param];
                        updateParamDisplay(param, params[param]);
                    }
                });

            // Dropdowns
            ['cellmode',
                'loopmodes',
                'loopmode',
                'samtrigtype',
                'polymode',
                'lfowave',
                'lfokeytrig',
                'lfobeatsync',
                'lforatebeatsync',
                'midimode',
                'reverse',
                'outputbus',
                'chokegrp',
                'slicestepmode',
                'legatomode',
                'interpqual',
                'quantsize',
                'synctype',
                'playthru',
                'slicerquantsize',
                'slicersync'].forEach(param => {
                    const select = document.getElementById(param);
                    if (select && params[param] !== undefined) {
                        select.value = params[param];
                    }
                });
        }

        async function loadPreset(file) {
            try {
                const text = await file.text();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(text, 'text/xml');

                presetData = { version: '2', pads: {}, tempo: '120' };
                assetCells = [];

                // Parse layer 0 cells (pads)
                const cells = xmlDoc.querySelectorAll('cell[layer="0"]');

                cells.forEach(cell => {
                    const row = parseInt(cell.getAttribute('row'));
                    const col = parseInt(cell.getAttribute('column'));

                    if (isNaN(row) || isNaN(col)) return;
                    if (!presetData.pads[row]) presetData.pads[row] = {};

                    const padData = {
                        filename: cell.getAttribute('filename') || '',
                        type: cell.getAttribute('type'),
                        params: {},
                        modsources: [],
                        slices: []
                    };

                    const params = cell.querySelector('params');
                    if (params) {
                        Array.from(params.attributes).forEach(attr => {
                            padData.params[attr.name] = attr.value;
                        });
                    }

                    cell.querySelectorAll('modsource').forEach(mod => {
                        const modSource = {
                            dest: mod.getAttribute('dest'),
                            src: mod.getAttribute('src'),
                            slot: mod.getAttribute('slot'),
                            amount: mod.getAttribute('amount')
                        };

                        // Add MIDI CC attributes if present
                        const mchan = mod.getAttribute('mchan');
                        const ccnum = mod.getAttribute('ccnum');
                        if (mchan !== null) modSource.mchan = mchan;
                        if (ccnum !== null) modSource.ccnum = ccnum;

                        padData.modsources.push(modSource);
                    });

                    // ADD THIS SECTION - Parse slices
                    const slicesNode = cell.querySelector('slices');
                    if (slicesNode) {
                        slicesNode.querySelectorAll('slice').forEach(slice => {
                            padData.slices.push({
                                pos: slice.getAttribute('pos')
                            });
                        });
                    }

                    presetData.pads[row][col] = padData;
                });



                // Parse asset cells (multi-samples)
                const assetNodes = xmlDoc.querySelectorAll('cell[type="asset"]');
                assetNodes.forEach((asset, index) => {
                    const params = asset.querySelector('params');
                    if (params) {
                        assetCells.push({
                            row: index,
                            filename: asset.getAttribute('filename') || '',
                            params: {
                                rootnote: params.getAttribute('rootnote') || '60',
                                keyrangebottom: params.getAttribute('keyrangebottom') || '0',
                                keyrangetop: params.getAttribute('keyrangetop') || '127',
                                velroot: params.getAttribute('velroot') || '64',
                                velrangebottom: params.getAttribute('velrangebottom') || '0',
                                velrangetop: params.getAttribute('velrangetop') || '127',
                                asssrcrow: params.getAttribute('asssrcrow') || '0',
                                asssrccol: params.getAttribute('asssrccol') || '0'
                            }
                        });
                    }
                });

                // Fill missing pads
                for (let row = 0; row < 4; row++) {
                    if (!presetData.pads[row]) presetData.pads[row] = {};
                    for (let col = 0; col < 4; col++) {
                        if (!presetData.pads[row][col]) {
                            presetData.pads[row][col] = createEmptyPadData();
                        }
                    }
                }

                // Initialize FX structure BEFORE parsing
                if (!presetData.fx) {
                    presetData.fx = createEmptyFXData();
                }

                // Parse FX cells (layer 3)
                const fxCells = xmlDoc.querySelectorAll('cell[layer="3"]');

                fxCells.forEach(cell => {
                    const row = parseInt(cell.getAttribute('row'));
                    const type = cell.getAttribute('type');

                    if (type === 'delay' || type === 'reverb' || type === 'eq') {
                        // Keep existing structure, just update it
                        if (!presetData.fx[type]) {
                            presetData.fx[type] = {
                                type: type,
                                params: {},
                                modsources: []
                            };
                        }

                        const params = cell.querySelector('params');
                        if (params) {
                            Array.from(params.attributes).forEach(attr => {
                                presetData.fx[type].params[attr.name] = attr.value;
                            });
                        }

                        // Clear existing modsources and load from XML
                        presetData.fx[type].modsources = [];

                        cell.querySelectorAll('modsource').forEach(mod => {
                            const modSource = {
                                dest: mod.getAttribute('dest'),
                                src: mod.getAttribute('src'),
                                slot: mod.getAttribute('slot'),
                                amount: mod.getAttribute('amount')
                            };

                            const mchan = mod.getAttribute('mchan');
                            const ccnum = mod.getAttribute('ccnum');
                            if (mchan !== null) modSource.mchan = mchan;
                            if (ccnum !== null) modSource.ccnum = ccnum;

                            presetData.fx[type].modsources.push(modSource);
                        });
                    }
                });

                const songCell = xmlDoc.querySelector('cell[type="song"]');
                if (songCell) {
                    const params = songCell.querySelector('params');
                    if (params) presetData.tempo = params.getAttribute('globtempo') || '120';
                }

                updatePadDisplay();
                initializeProject();
                setStatus(`Loaded: ${file.name} (${assetCells.length} multi-sample assets)`, 'success');
            } catch (error) {
                setStatus(`Error loading: ${error.message}`, 'error');
                console.error(error);
            }
        }

        function savePreset() {
            if (!presetData) {
                setStatus('No preset to save', 'error');
                return;
            }

            try {
                const xml = generatePresetXML(presetData);
                const blob = new Blob([xml], { type: 'text/xml' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'preset.xml';
                a.click();
                URL.revokeObjectURL(url);

                setStatus('Preset saved successfully', 'success');
            } catch (error) {
                setStatus(`Error saving: ${error.message}`, 'error');
                console.error(error);
            }
        }

        function generatePresetXML(data) {
            let xml = '<?xml version="1.0" encoding="UTF-8"?>\n<document>\n    <session version="2">\n';

            // Layer 0 - Pads
            for (let col = 0; col < 4; col++) {
                for (let row = 0; row < 4; row++) {
                    const pad = data.pads[row]?.[col];
                    if (!pad) continue;

                    xml += `        <cell row="${row}" column="${col}" layer="0" filename="${pad.filename}" type="${pad.type}">\n`;
                    xml += '            <params';
                    for (let [key, value] of Object.entries(pad.params)) {
                        xml += ` ${key}="${value}"`;
                    }
                    xml += '/>\n';

                    // Modsources - filter out 'none' slots
                    if (pad.modsources?.length > 0) {
                        const activeModSlots = pad.modsources.filter(mod =>
                            mod.src !== 'none' && mod.dest !== 'none' && mod.src && mod.dest
                        );

                        activeModSlots.forEach(mod => {
                            xml += `            <modsource dest="${mod.dest}" src="${mod.src}"`;

                            // Add MIDI CC attributes if present
                            if (mod.mchan !== undefined) {
                                xml += ` mchan="${mod.mchan}"`;
                            }
                            if (mod.ccnum !== undefined) {
                                xml += ` ccnum="${mod.ccnum}"`;
                            }

                            xml += ` slot="${mod.slot}" amount="${mod.amount}"/>\n`;
                        });
                    }


                    // ADD THIS SECTION - Output slices
                    if (pad.slices && pad.slices.length > 0) {
                        xml += '            <slices>\n';
                        pad.slices.forEach(slice => {
                            xml += `                <slice pos="${slice.pos}"/>\n`;
                        });
                        xml += '            </slices>\n';
                    } else {
                        xml += '            <slices/>\n';
                    }


                    xml += '        </cell>\n';
                }
            }

            // Layer 3 - FX
            const fxTypes = ['delay', 'reverb', 'eq'];
            const fxDefaults = createEmptyFXData();

            for (let i = 0; i < 5; i++) {
                let fxType = null;
                let fxData = null;

                if (i === 0) {
                    fxType = 'delay';
                    fxData = presetData.fx?.delay || fxDefaults.delay;
                } else if (i === 1) {
                    fxType = 'reverb';
                    fxData = presetData.fx?.reverb || fxDefaults.reverb;
                } else if (i === 2) {
                    fxType = 'eq';
                    fxData = presetData.fx?.eq || fxDefaults.eq;
                } else {
                    // Null FX for slots 3 and 4
                    xml += `        <cell row="${i}" layer="3" type="null">\n`;
                    xml += '            <params/>\n';
                    xml += '        </cell>\n';
                    continue;
                }

                xml += `        <cell row="${i}" layer="3" type="${fxType}">\n`;
                xml += '            <params';
                for (let [key, value] of Object.entries(fxData.params)) {
                    xml += ` ${key}="${value}"`;
                }
                xml += '/>\n';

                // Add FX modsources (filter out 'none')
                if (fxData.modsources?.length > 0) {
                    const activeModSlots = fxData.modsources.filter(mod =>
                        mod.src !== 'none' && mod.dest !== 'none' && mod.src && mod.dest
                    );

                    // Group by destination and assign slot numbers 0-2 per destination
                    const destGroups = {};
                    activeModSlots.forEach(mod => {
                        if (!destGroups[mod.dest]) {
                            destGroups[mod.dest] = [];
                        }
                        destGroups[mod.dest].push(mod);
                    });

                    // Write with corrected slot numbers
                    Object.values(destGroups).forEach(group => {
                        group.forEach((mod, index) => {
                            xml += `            <modsource dest="${mod.dest}" src="${mod.src}"`;
                            if (mod.mchan !== undefined) xml += ` mchan="${mod.mchan}"`;
                            if (mod.ccnum !== undefined) xml += ` ccnum="${mod.ccnum}"`;
                            xml += ` slot="${index}" amount="${mod.amount}"/>\n`;  // Use index (0-2) per dest
                        });
                    });
                }

                xml += '        </cell>\n';
            }

            // Asset cells - preserve multi-sample references
            assetCells.forEach((asset, index) => {
                xml += `        <cell row="${index}" filename="${asset.filename}" type="asset">\n`;
                xml += `            <params rootnote="${asset.params.rootnote}" keyrangebottom="${asset.params.keyrangebottom}" keyrangetop="${asset.params.keyrangetop}" velroot="${asset.params.velroot}" velrangebottom="${asset.params.velrangebottom}" velrangetop="${asset.params.velrangetop}" asssrcrow="${asset.params.asssrcrow}" asssrccol="${asset.params.asssrccol}"/>\n`;
                xml += '        </cell>\n';
            });

            // Layer 8 - Inputs
            for (let i = 0; i < 8; i++) {
                xml += `        <cell row="${i}" layer="8" type="ioconnectin">\n            <params inputiocon="gatein"/>\n        </cell>\n`;
            }

            // Layer 9 - Outputs
            const outputs = ['chanout1', 'chanout2', 'chanout3', 'chanout4', 'chanout5', 'chanout6', 'masterout1', 'masterout2'];
            for (let i = 0; i < 8; i++) {
                xml += `        <cell row="${i}" layer="9" type="ioconnectout">\n            <params outputiocon="${outputs[i]}"/>\n        </cell>\n`;
            }

            // Song settings
            xml += `        <cell type="song">\n            <params globtempo="${data.tempo}" songmode="0" sectcount="1" sectloop="1" swing="50" keymode="1" keyroot="3"/>\n        </cell>\n`;
            xml += '    </session>\n</document>\n';

            return xml;
        }

        async function exportSelectedPads() {
            if (selectedPads.size === 0) {
                setStatus('No pads selected', 'error');
                return;
            }

            const playmodeNames = {
                '0': 'Sample',
                '1': 'Clip',
                '2': 'Slice',
                '3': 'Granular'
            };

            const files = {};

            for (const padNum of selectedPads) {
                const pad = document.querySelector(`[data-padnum="${padNum}"]`);
                const row = parseInt(pad.dataset.row);
                const col = parseInt(pad.dataset.col);
                const padData = presetData.pads[row][col];

                if (!padData) continue;

                // Get sample name
                let sampleName = 'Empty';
                if (padData.filename) {
                    sampleName = padData.filename.split(/[/\\]/).pop().replace(/\.(wav|WAV)$/, '');
                }

                // Get playmode
                const cellmode = padData.params.cellmode || '0';
                const playmode = playmodeNames[cellmode] || 'Sample';

                // Check for multisample mode
                const isMultisample = padData.params.multisammode === '1';
                const finalPlaymode = isMultisample ? 'Multisample' : playmode;

                // Build filename
                const filename = `${projectName}_${sampleName}_${finalPlaymode}_Pad${padNum.toString().padStart(2, '0')}.json`;

                // Build export data
                const exportData = {
                    padNumber: padNum,
                    row: row,
                    col: col,
                    projectName: projectName,
                    sampleName: sampleName,
                    playmode: finalPlaymode,
                    data: {
                        filename: padData.filename,
                        type: padData.type,
                        params: padData.params,
                        modsources: padData.modsources || [],
                        slices: padData.slices || []
                    }
                };

                // Add asset references if multisample
                if (isMultisample) {
                    exportData.assetReferences = assetCells.filter(asset =>
                        parseInt(asset.params.asssrcrow) === row &&
                        parseInt(asset.params.asssrccol) === col
                    );
                }

                files[filename] = JSON.stringify(exportData, null, 2);
            }

            // Single pad - download directly as JSON
            if (selectedPads.size === 1) {
                const filename = Object.keys(files)[0];
                const content = files[filename];
                const blob = new Blob([content], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
                setStatus(`Exported 1 pad as JSON`, 'success');
                return;
            }

            // Multiple pads - create ZIP
            try {
                // Convert strings to Uint8Array for fflate
                const filesForZip = {};
                for (const [name, content] of Object.entries(files)) {
                    filesForZip[name] = new TextEncoder().encode(content);
                }

                const zipped = fflate.zipSync(filesForZip);
                const blob = new Blob([zipped], { type: 'application/zip' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${projectName}_pads_export.zip`;
                a.click();
                URL.revokeObjectURL(url);

                setStatus(`Exported ${selectedPads.size} pads to ZIP`, 'success');
            } catch (error) {
                setStatus(`Error creating ZIP: ${error.message}`, 'error');
                console.error(error);
            }
        }

        function copySelectedPads() {
            if (selectedPads.size === 0) {
                setStatus('No pads selected', 'error');
                return;
            }

            clipboard = [];
            selectedPads.forEach(padNum => {
                const pad = document.querySelector(`[data-padnum="${padNum}"]`);
                const row = parseInt(pad.dataset.row);
                const col = parseInt(pad.dataset.col);
                clipboard.push(JSON.parse(JSON.stringify(presetData.pads[row][col])));
            });

            updateButtonStates();
            setStatus(`Copied ${clipboard.length} pad(s)`, 'success');
        }

        function pasteToSelected() {
            if (!clipboard || clipboard.length === 0) {
                setStatus('Nothing to paste', 'error');
                return;
            }

            if (selectedPads.size === 0) {
                setStatus('No destination pad selected', 'error');
                return;
            }

            const targets = Array.from(selectedPads);
            clipboard.forEach((data, i) => {
                if (i >= targets.length) return;
                const pad = document.querySelector(`[data-padnum="${targets[i]}"]`);
                const row = parseInt(pad.dataset.row);
                const col = parseInt(pad.dataset.col);
                presetData.pads[row][col] = JSON.parse(JSON.stringify(data));
            });

            updatePadDisplay();
            setStatus(`Pasted ${Math.min(clipboard.length, targets.length)} pad(s)`, 'success');
        }

        function deleteSelectedPads() {
            if (selectedPads.size === 0) {
                setStatus('No pads selected', 'error');
                return;
            }

            const count = selectedPads.size;
            selectedPads.forEach(padNum => {
                const pad = document.querySelector(`[data-padnum="${padNum}"]`);
                const row = parseInt(pad.dataset.row);
                const col = parseInt(pad.dataset.col);
                presetData.pads[row][col] = createEmptyPadData();
            });

            updatePadDisplay();
            clearPadSelection();
            updateButtonStates();
            setStatus(`Deleted ${count} pad(s)`, 'success');
        }

        function updatePadDisplay() {
            if (!presetData) return;

            for (let row = 0; row < 4; row++) {
                for (let col = 0; col < 4; col++) {
                    const pad = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
                    if (!pad) continue;

                    const padData = presetData.pads[row]?.[col];
                    const label = pad.querySelector('.pad-label');

                    if (padData && padData.filename && padData.type !== 'samtempl') {
                        pad.classList.remove('empty');
                        pad.classList.add('active');
                        label.textContent = padData.filename.split(/[/\\]/).pop().replace('.wav', '');
                    } else {
                        pad.classList.add('empty');
                        pad.classList.remove('active');
                        label.textContent = 'Empty';
                    }
                }
            }
        }

        function setStatus(message, type = '') {
            // Check which context we're in
            let statusBar;

            // Check if edit modal is open
            const editModal = document.getElementById('editModal');
            if (editModal && editModal.classList.contains('show')) {
                statusBar = document.getElementById('editModalStatusBar');
            }

            // Check if FX modal is open
            const fxModal = document.getElementById('fxModal');
            if (fxModal && fxModal.classList.contains('show')) {
                statusBar = document.getElementById('fxModalStatusBar');
            }

            // Fallback to main status bar
            if (!statusBar) {
                statusBar = document.getElementById('statusBar');
            }

            if (statusBar) {
                statusBar.textContent = message;
                statusBar.className = 'status-bar ' + type;

                // Auto-clear after 5 seconds for success/error messages
                if (type === 'success' || type === 'error') {
                    setTimeout(() => {
                        if (statusBar.textContent === message) {
                            statusBar.textContent = '';
                            statusBar.className = 'status-bar';
                        }
                    }, 5000);
                }
            }
        }
    </script>
</body>

</html>